const $e={title:"Information",closeLabel:"Fermer",okLabel:"Ok",backdrop:!0,keyboard:!0},Ce={title:"Confirmer",closeLabel:"Annuler",cancelLabel:"Annuler",confirmLabel:"Confirmer",backdrop:!0,keyboard:!0};function Ie({title:e,closeLabel:t,okLabel:n}){const s=document.createElement("div");return s.className="modal fade",s.id="alertBsModal",s.tabIndex=-1,s.setAttribute("aria-labelledby","alertBsModalLabel"),s.setAttribute("aria-hidden","true"),s.innerHTML=`
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertBsModalLabel">${e}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="${t}"></button>
                </div>
                <div class="modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary btn-alert-ok">${n}</button>
                </div>
            </div>
        </div>
    `,s}function l(e,t={}){var c,m,g;if(!((c=window.bootstrap)!=null&&c.Modal)){(m=window.alert)==null||m.call(window,e);return}const n={...$e,...t},s=document.getElementById("alertBsModal");if(s){const p=(g=window.bootstrap)==null?void 0:g.Modal.getInstance(s);p&&p.hide(),s.remove()}const o=Ie(n);o.querySelector(".modal-body").innerHTML=typeof e=="string"?e.replace(/\n/g,"<br>"):e,document.body.appendChild(o);const i=new window.bootstrap.Modal(o,{backdrop:n.backdrop,keyboard:n.keyboard}),a=()=>{o.removeEventListener("hidden.bs.modal",a),o.remove()};o.addEventListener("hidden.bs.modal",a,{once:!0});const r=o.querySelector(".btn-alert-ok");r==null||r.addEventListener("click",()=>i.hide(),{once:!0}),i.show()}function Le({title:e,closeLabel:t,confirmLabel:n,cancelLabel:s}){const o=document.createElement("div");return o.className="modal fade",o.id="confirmBsModal",o.tabIndex=-1,o.setAttribute("aria-labelledby","confirmBsModalLabel"),o.setAttribute("aria-hidden","true"),o.innerHTML=`
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmBsModalLabel">${e}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="${t}"></button>
                </div>
                <div class="modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-confirm-cancel">${s}</button>
                    <button type="button" class="btn btn-danger btn-confirm-ok">${n}</button>
                </div>
            </div>
        </div>
    `,o}function M(e,t={}){var a,r;if(!((a=window.bootstrap)!=null&&a.Modal)){const c=window.confirm?window.confirm(e):!0;return Promise.resolve(c)}const n={...Ce,...t},s=document.getElementById("confirmBsModal");if(s){const c=(r=window.bootstrap)==null?void 0:r.Modal.getInstance(s);c&&c.hide(),s.remove()}const o=Le(n);o.querySelector(".modal-body").innerHTML=typeof e=="string"?e.replace(/\n/g,"<br>"):e,document.body.appendChild(o);const i=new window.bootstrap.Modal(o,{backdrop:n.backdrop,keyboard:n.keyboard});return new Promise(c=>{var k,S;let m=!1;const g=()=>{var E,C;o.removeEventListener("hidden.bs.modal",p),(E=o.querySelector(".btn-confirm-ok"))==null||E.removeEventListener("click",y),(C=o.querySelector(".btn-confirm-cancel"))==null||C.removeEventListener("click",x),o.remove()},p=()=>{m||(m=!0,c(!1)),g()},y=()=>{m||(m=!0,c(!0)),i.hide()},x=()=>{m||(m=!0,c(!1)),i.hide()};o.addEventListener("hidden.bs.modal",p,{once:!0}),(k=o.querySelector(".btn-confirm-ok"))==null||k.addEventListener("click",y,{once:!0}),(S=o.querySelector(".btn-confirm-cancel"))==null||S.addEventListener("click",x,{once:!0}),i.show()})}window.alertBs=l;window.confirmBs=M;const u="",P=new URLSearchParams(window.location.search);let re=P.get("list")||null;function R(){return re}function ae(e){re=e}function Te(){const e=document.querySelector('meta[name="app:auth"]');let t="",n="",s=null,o=!1;if(e){const r=e.dataset;r&&(t=(r.email||"").trim(),n=(r.sessionEmail||"").trim(),s=r.name||null,o=r.authenticated==="1")}const i=document.querySelector('meta[name="csrf-token"]');i&&(window.csrfToken=i.getAttribute("content"));const a=t||n||"";window.authUser={email:a||null,name:s,isAuthenticated:o},window.userEmail=a,window.isAuthenticated=o,window.sessionEmail=n}function xe(){if(typeof window>"u"||typeof window.fetch!="function"||window.fetch.__isAuthenticatedWrapper)return;const e=window.fetch.bind(window);window.fetch=(t,n={})=>{const s={...n};s.credentials=s.credentials||"include";const o=new Headers(s.headers||{});if(o.has("Accept")||o.set("Accept","application/json"),window.csrfToken&&!o.has("X-CSRF-Token")){const i=(s.method||"GET").toUpperCase();i!=="GET"&&i!=="HEAD"&&o.set("X-CSRF-Token",window.csrfToken)}return s.headers=o,e(t,s)},window.fetch.__isAuthenticatedWrapper=!0}function f(){const e=localStorage.getItem("simpleTodo_email");return e?e.trim():""}function D(e){const t=(e||"").trim();t?(localStorage.setItem("simpleTodo_email",t),typeof window<"u"&&(window.userEmail=t)):(localStorage.removeItem("simpleTodo_email"),typeof window<"u"&&(window.userEmail="")),F()}function T(){let e="";if(typeof window<"u"&&window.userEmail&&typeof window.userEmail=="string"&&window.userEmail.trim()!==""&&(e=window.userEmail.trim()),!e){const t=f();t&&(e=t)}return e}function F(){const e=document.querySelectorAll(".user-email");if(!e.length)return;const t=!!(typeof window<"u"&&window.isAuthenticated),n=T();e.forEach(s=>{const o=s.querySelector(".user-email-text");o&&(t&&n?(o.textContent=n,s.style.display="inline-flex",typeof window<"u"&&(window.userEmail=n,window.authUser||(window.authUser={}),window.authUser.email=n,window.authUser.isAuthenticated=!0)):(o.textContent="",s.style.display="none"))})}function ke(){return"list_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function le(){const e=T(),t=e?`<span class="badge bg-light text-dark" style="font-size: 0.85rem;">${e}</span>`:"",n=e?`-- Sélectionner une liste pour ${e} --`:"-- Sélectionner une liste --",s=e||"";document.body.innerHTML=`
        <div class="container" style="max-width: 600px; margin: 100px auto;">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #8fa4f5 0%, #b491e8 100%); color: white;">
                    <div class="d-flex align-items-center justify-content-between">
                        <h2 class="mb-0"><i class="bi bi-check2-square"></i> SimpleTodo</h2>
                        ${t}
                    </div>
                </div>
                <div class="card-body">
                    <h5 class="mb-4">Choisir ou créer une liste</h5>
                    
                    <div class="mb-4">
                        <label class="form-label">Mes listes</label>
                        <select id="myLists" class="form-select mylists-select">
                            <option value="">${n}</option>
                        </select>
                        <button class="btn btn-primary w-100 mt-2" onclick="loadSelectedList()">
                            <i class="bi bi-box-arrow-in-right"></i> Ouvrir cette liste
                        </button>
                    </div>
                    
                    <hr>
                    
                    <div>
                        <label class="form-label">Créer une nouvelle liste</label>
                        <input type="text" id="newListTitle" class="form-control mb-2" placeholder="Nom de la liste" maxlength="100">
                        <input type="email" id="newListEmail" class="form-control mb-2" placeholder="Votre email (pour être le créateur)" maxlength="255" value="${s}">
                        <small class="text-muted d-block mb-2">Votre email vous donnera les droits de créateur (modifier le thème, supprimer la liste)</small>
                        <button class="btn btn-success w-100" onclick="createNewList()">
                            <i class="bi bi-plus-circle"></i> Créer une nouvelle liste
                        </button>
                    </div>
                    
                    <hr>
                    
                    <div>
                        <label class="form-label">Recevoir un email d'authentification</label>
                        <input type="email" id="authEmail" class="form-control mb-2" placeholder="Votre email" maxlength="255">
                        <small class="text-muted d-block mb-2">Un lien d'authentification vous sera envoyé par email</small>
                        <button class="btn btn-info w-100" onclick="requestAuthEmail()">
                            <i class="bi bi-envelope"></i> Envoyer l'email
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `,Be()}async function Se(){const e=[],t=T(),n=t?`-- Sélectionner une liste pour ${t} --`:"-- Sélectionner une liste --";try{const o=await fetch(`${u}/api/mylists`);o.ok?(await o.json()).forEach(a=>{e.push({listId:a.id,title:a.title})}):console.log("Erreur lors du chargement des listes depuis l'API:",o.status)}catch(o){console.error("Erreur lors du chargement des listes depuis l'API:",o)}for(let o=0;o<localStorage.length;o++){const i=localStorage.key(o);if(i.startsWith("simpleTodo_list_")){const a=localStorage.getItem(i),r=JSON.parse(a);r&&r.listId&&(e.find(m=>m.listId===r.listId)||e.push({listId:r.listId,title:r.title||r.listId}))}}return document.querySelectorAll(".mylists-select").forEach(o=>{o.innerHTML=`<option value="">${n}</option>`,e.forEach(i=>{const a=document.createElement("option");a.value=i.listId,a.textContent=i.title,o.appendChild(a)}),e.length===0&&(o.innerHTML='<option value="">Aucune liste disponible</option>')}),e}function Be(){Se()}async function Me(){const e=document.getElementById("myLists");if(!e)return;const t=e.value;if(t)try{const n=await fetch(`${u}/api/lists/${t}`);if(!n.ok||n.status===404){localStorage.removeItem(`simpleTodo_list_${t}`);for(let s=localStorage.length-1;s>=0;s--){const o=localStorage.key(s);if(o&&o.startsWith("simpleTodo_token_")){const i=JSON.parse(localStorage.getItem(o));i&&i.listId===t&&localStorage.removeItem(o)}}l("Cette liste n'existe plus. Retour à l'accueil."),window.location.href="/";return}window.location.href=`/${t}`}catch(n){console.error("Erreur lors de la vérification de la liste:",n),l("Erreur lors de la vérification de la liste.")}}async function _e(){const e=document.getElementById("newListTitle"),t=document.getElementById("newListEmail");if(!e)return;const n=e.value.trim();if(!n){l("Veuillez entrer un nom pour la liste");return}const o=(t?t.value.trim():"")||f();if(!o){l("Veuillez entrer votre email pour devenir le créateur de la liste"),t&&t.focus();return}f()||D(o);const i=ke();try{(await fetch(`${u}/api/lists/${i}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:n,creator_email:o})})).ok?window.location.href=`/${i}`:l("Erreur lors de la création de la liste")}catch(a){console.error("Erreur:",a),l("Erreur de connexion lors de la création de la liste")}}async function Ae(){const e=document.getElementById("authEmail");if(!e)return;const t=e.value.trim();if(!t||!t.includes("@")){l("Veuillez entrer une adresse email valide");return}try{const n=await fetch(`${u}/api/auth/request-email`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t})});if(n.ok)l("Un email avec vos liens d'authentification a été envoyé !"),e.value="";else{const s=await n.json();l(s.message||"Erreur lors de l'envoi de l'email")}}catch(n){console.error("Erreur:",n),l("Erreur de connexion")}}function De(){const t=window.location.pathname.match(/^\/([^\/]+)\/([^\/]+)$/);if(t){const n=t[1];return ae(n),{listId:n,token:t[2]}}return null}function je(){let e=P.get("token");if(e)return e;const t=De();return t?t.token:null}let $=R(),B=null;function V(e){$=e}function Pe(e){switch((e||"medium").toLowerCase()){case"high":return"danger";case"low":return"secondary";default:return"primary"}}function Oe(){const e=document.getElementById("mistralGenerateBtn"),t=document.getElementById("mistralImportBtn"),n=document.getElementById("mistralModal");if(!e||!n)return;const s=e.innerHTML,o=document.getElementById("mistralPrompt"),i=document.getElementById("mistralMaxItems"),a=document.getElementById("mistralDeadline"),r=document.getElementById("mistralAlert"),c=document.getElementById("mistralStatus"),m=document.getElementById("mistralResultWrapper"),g=document.getElementById("mistralResultTitle"),p=document.getElementById("mistralResultSummary"),y=document.getElementById("mistralResultItems"),x=()=>{B=null,r&&(r.classList.add("d-none"),r.textContent=""),c&&(c.classList.add("d-none"),c.classList.remove("text-success","text-danger"),c.classList.add("text-muted"),c.textContent=""),m&&(m.classList.add("d-none"),g.textContent="",p.textContent="",y.innerHTML=""),a&&(a.value=""),e.disabled=!1,e.innerHTML=s,t&&(t.disabled=!0)};n.addEventListener("shown.bs.modal",()=>{x(),o==null||o.focus()});const k=async()=>{if(!o||!i||!r||!m||!g||!p||!y)return;const E=o.value.trim(),C=parseInt(i.value,10),A=a!=null&&a.value?a.value:null,H=typeof window<"u"?window.userEmail||T():"",I=H?H.trim():"";if(!window.isListCreator){r.textContent="Seul le propriétaire de la liste peut utiliser la génération Mistral.",r.classList.remove("d-none");return}if(E===""){r.textContent="Veuillez décrire ce que vous souhaitez générer.",r.classList.remove("d-none");return}r.classList.add("d-none"),m.classList.add("d-none"),e.disabled=!0,e.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Génération en cours…',c&&(c.classList.remove("d-none","text-success","text-danger"),c.classList.add("text-muted"),c.innerHTML='<i class="bi bi-hourglass-split me-1"></i>Génération en cours…');try{const v=await fetch(`${u}/api/mistral/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-User-Email":I||""},body:JSON.stringify({prompt:E,max_items:Number.isNaN(C)?void 0:C,deadline:A,list_id:$,email:I||void 0})});if(!v.ok){const b=await v.json().catch(()=>null);throw new Error((b==null?void 0:b.message)||"Erreur lors de la génération.")}const L=await v.json();B=L,g.textContent=L.title||"Liste générée",p.textContent=L.summary||"",p.style.display=L.summary?"block":"none",Array.isArray(L.items)&&L.items.length?y.innerHTML=L.items.map((b,ve)=>`
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <span class="fw-semibold">${h(b.title||`Tâche ${ve+1}`)}</span>
                            <span class="badge bg-${Pe(b.priority)} text-uppercase">${b.priority||"medium"}</span>
                        </div>
                        ${b.description?`<p class="mb-1">${h(b.description)}</p>`:""}
                        <div class="text-muted small d-flex flex-wrap gap-3">
                            ${b.category?`<span><i class="bi bi-tag"></i> ${h(b.category)}</span>`:""}
                            ${b.due_date?`<span><i class="bi bi-calendar-event"></i> ${h(b.due_date)}</span>`:""}
                        </div>
                    </li>
                `).join(""):y.innerHTML=`
                    <li class="list-group-item text-muted text-center">
                        <i class="bi bi-info-circle"></i> Aucune tâche générée.
                    </li>
                `,m.classList.remove("d-none"),t&&(t.disabled=!1),c&&(c.classList.remove("text-muted","text-danger"),c.classList.add("text-success"),c.innerHTML='<i class="bi bi-check-circle me-1"></i>Génération terminée.')}catch(v){console.error("[Mistral] Generation error:",v),r.textContent=v instanceof Error?v.message:"Erreur inattendue.",r.classList.remove("d-none"),c&&(c.classList.remove("text-muted","text-success"),c.classList.add("text-danger"),c.innerHTML='<i class="bi bi-exclamation-triangle me-1"></i>Erreur lors de la génération.')}finally{e.disabled=!1,e.innerHTML=s}},S=async()=>{if(!B||!Array.isArray(B.items)||!B.items.length){l("Aucune tâche à importer.");return}try{const E=localStorage.getItem("simpleTodo_pseudo")||"Mistral",C=T();t&&(t.disabled=!0,t.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Import en cours...');for(const[H,I]of B.items.entries()){const v={text:I.title||`Tâche générée ${H+1}`,pseudo:E,description:I.description||null,due_date:I.due_date||null,priority:I.priority||"medium",category_name:I.category||null,source:"mistral"};await fetch(`${u}/api/todos/${$}`,{method:"POST",headers:{"Content-Type":"application/json",...C?{"X-User-Email":C}:{}},body:JSON.stringify(v)})}w(),l("Tâches importées avec succès depuis Mistral."),t&&(t.disabled=!1,t.innerHTML='<i class="bi bi-plus-circle"></i> Importer dans la liste');const A=bootstrap.Modal.getInstance(n);A==null||A.hide()}catch(E){console.error("[Mistral] Import error:",E),l("Erreur lors de l'import des tâches générées."),t&&(t.disabled=!1,t.innerHTML='<i class="bi bi-plus-circle"></i> Importer dans la liste');return}t&&(t.innerHTML='<i class="bi bi-plus-circle"></i> Importer dans la liste')};e.addEventListener("click",k),t&&t.addEventListener("click",S)}async function w(){try{const t=await(await fetch(`${u}/api/todos/${$}`)).json();He(t),Ne(t)}catch(e){console.error("Erreur lors du chargement des todos:",e)}}function He(e){const t=document.getElementById("todoList");if(!t)return;if(!e.length){t.innerHTML=`
            <div class="text-center text-muted py-5">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-3">Aucune tâche pour le moment</p>
            </div>
        `;return}const n=new Map,s=[];e.forEach(i=>{if(i.category){const a=`cat_${i.category.id}`;n.has(a)||n.set(a,{name:i.category.name,color:i.category.color,nextDate:i.category.next_date||null,todos:[]});const r=n.get(a);i.category.next_date&&(!r.nextDate||i.category.next_date<r.nextDate)&&(r.nextDate=i.category.next_date),r.todos.push(i)}else s.push(i)});let o="";s.length&&(o+=`
            <div class="mb-3">
                ${s.map(i=>Y(i)).join("")}
            </div>
        `),n.size&&(o+='<div class="accordion" id="todoAccordion">',Array.from(n.entries()).sort((a,r)=>{const c=a[1].nextDate||null,m=r[1].nextDate||null;if(c&&m){const y=new Date(c)-new Date(m);if(y!==0)return y}else{if(c&&!m)return-1;if(!c&&m)return 1}const g=a[1].name.toLowerCase(),p=r[1].name.toLowerCase();return g.localeCompare(p,"fr")}).forEach(([a,r],c)=>{const m=`collapse_${a}`,g=`heading_${a}`,p=c===0&&!s.length,y=r.color||"#6c757d",x=r.todos.map(S=>Y(S)).join(""),k=Ue(r.nextDate)||"";o+=`
                <div class="accordion-item">
                    <h2 class="accordion-header" id="${g}">
                        <button class="accordion-button ${p?"":"collapsed"}" type="button"
                            data-bs-toggle="collapse" data-bs-target="#${m}"
                            aria-expanded="${p?"true":"false"}" aria-controls="${m}">
                            <span class="badge rounded-pill me-2" style="background-color: ${y}; color: #fff;">
                                ${h(r.name)}
                            </span>
                            <span class="ms-1 text-muted">${r.todos.length} tâche${r.todos.length>1?"s":""}</span>
                            ${k}
                        </button>
                    </h2>
                    <div id="${m}" class="accordion-collapse collapse ${p?"show":""}"
                        aria-labelledby="${g}" data-bs-parent="#todoAccordion">
                        <div class="accordion-body p-0">
                            ${x}
                        </div>
                    </div>
                </div>
            `}),o+="</div>"),t.innerHTML=o,window.updateCommentBadge&&e.forEach(i=>{window.updateCommentBadge(i.id)})}function Y(e){const t=e.comments?e.comments.length:0,n=e.due_date?ce(e.due_date):"Aucune date",s=e.completed?"bi-arrow-counterclockwise":"bi-check-lg",o=e.completed?"Marquer comme non terminé":"Marquer comme terminé",i=e.completed?"btn btn-sm btn-outline-success flex-shrink-0":"btn btn-sm btn-outline-primary flex-shrink-0",a=e.pseudo?`<span class="badge bg-light text-dark pseudo-badge ms-2"><i class="bi bi-person-fill"></i> ${h(e.pseudo)}</span>`:"",r=e.assigned_to?`<span class="badge bg-info text-dark pseudo-badge ms-2"><i class="bi bi-person-check"></i> ${h(e.assigned_to)}</span>`:"",c=t>0?"btn btn-sm btn-outline-primary":"btn btn-sm btn-outline-secondary";return`
        <div class="todo-item ${e.completed?"completed":""}" data-id="${e.id}" data-category="${e.category?e.category.id:""}" data-assigned="${e.assigned_to?h(e.assigned_to):""}" data-due-date="${e.due_date||""}" data-completed="${e.completed?"1":"0"}">
            <div class="d-flex align-items-start gap-2">
                <button class="${i}" title="${o}"
                    onclick="event.stopPropagation(); toggleTodo(${e.id})">
                    <i class="bi ${s}"></i>
                </button>
                <div class="flex-grow-1">
                    <div>
                        <span class="todo-text ${e.completed?"completed":""}">${h(e.text)}</span>
                        ${e.completed?'<span class="badge bg-success ms-2"><i class="bi bi-check-circle"></i> Terminé</span>':""}
                        ${a}
                        ${r}
                    </div>
                    <div class="text-muted" style="font-size: 0.85rem;">
                        Ajouté par <strong>${h(e.pseudo||"Anonyme")}</strong>
                        • ${n}
                    </div>
                </div>
                <div class="d-flex gap-2 flex-shrink-0">
                    <button id="comment-button-${e.id}" class="${c} btn-comment-wrapper" title="Afficher les commentaires"
                        onclick="event.stopPropagation(); toggleComments(${e.id})">
                        <i class="bi bi-chat-dots"></i>
                        <span class="comment-badge" id="comment-badge-${e.id}" ${t>0?"":'style="display:none;"'}>${t}</span>
                        <span class="comment-badge comment-badge-new d-none" id="comment-new-badge-${e.id}"></span>
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                            id="dropdownMenuButton${e.id}" data-bs-toggle="dropdown" aria-expanded="false"
                            onclick="event.stopPropagation();">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton${e.id}">
                            ${e.assigned_to?"":`<li><a class="dropdown-item" href="#" onclick="event.stopPropagation(); assignTodo(${e.id}); return false;"><i class="bi bi-person-plus me-2"></i>Je m'en occupe</a></li>`}
                            <li><a class="dropdown-item" href="#" onclick="event.stopPropagation(); changeCategory(${e.id}); return false;"><i class="bi bi-tag me-2"></i>Changer de catégorie</a></li>
                            <li><a class="dropdown-item" href="#" onclick="event.stopPropagation(); changeDueDate(${e.id}); return false;"><i class="bi bi-calendar-plus me-2"></i>Modifier la date</a></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="event.stopPropagation(); deleteTodo(${e.id}); return false;"><i class="bi bi-trash me-2"></i>Supprimer</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="comments-section" id="comments-${e.id}" style="display: none;">
                <div class="comment-list" id="comments-list-${e.id}"></div>
                <div class="comment-form input-group mt-2">
                    <input type="text" class="form-control" id="comment-input-${e.id}" placeholder="Ajouter un commentaire...">
                    <button class="btn btn-outline-primary" type="button" onclick="addComment(${e.id})">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
        </div>
    `}function h(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function ce(e){return new Date(e).toLocaleDateString("fr-FR",{year:"numeric",month:"long",day:"numeric"})}function Ue(e){if(!e)return null;const t=new Date;t.setHours(0,0,0,0);const n=new Date(e);n.setHours(0,0,0,0);const s=Math.round((n-t)/864e5);let o="badge ms-auto text-uppercase",i="bi-calendar-event";return s<=0?(o+=" bg-danger",i="bi-exclamation-octagon"):s<=7?(o+=" bg-warning text-dark",i="bi-exclamation-triangle"):o+=" bg-primary",`<span class="${o}"><i class="bi ${i} me-1"></i>${h(ce(e))}</span>`}function Ne(e){const t=e.length,n=e.filter(r=>r.completed).length,s=t-n,o=document.getElementById("totalCount"),i=document.getElementById("completedCount"),a=document.getElementById("remainingCount");o&&(o.textContent=t),i&&(i.textContent=n),a&&(a.textContent=s)}async function de(){const e=document.getElementById("todoInput"),t=localStorage.getItem("simpleTodo_pseudo");if(!e)return;const n=e.value.trim();if(!n){l("Veuillez entrer une tâche");return}try{(await fetch(`${u}/api/todos/${$}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:n,pseudo:t||"Anonyme"})})).ok?(e.value="",w()):l("Erreur lors de l'ajout de la tâche")}catch(s){console.error("Erreur lors de l'ajout de la tâche:",s),l("Erreur de connexion")}}async function qe(e){const t=document.querySelector(`.todo-item[data-id="${e}"]`),s=!((t==null?void 0:t.getAttribute("data-completed"))==="1");try{const o=await fetch(`${u}/api/todos/${$}/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({completed:s})});if(o.ok)w();else if(o.status===422){const i=await o.json().catch(()=>null);console.error("Validation toggle todo:",i),l((i==null?void 0:i.message)||"Validation impossible pour cette tâche")}else l("Erreur lors du changement d'état de la tâche")}catch(o){console.error("Erreur toggle todo:",o),l("Erreur de connexion")}}async function Fe(e){if(await M("Êtes-vous sûr de vouloir supprimer cette tâche ?"))try{(await fetch(`${u}/api/todos/${$}/${e}`,{method:"DELETE"})).ok?w():l("Erreur lors de la suppression de la tâche")}catch(n){console.error("Erreur suppression todo:",n),l("Erreur de connexion")}}async function Je(){if(await M("Êtes-vous sûr de vouloir supprimer toutes les tâches terminées ?"))try{(await fetch(`${u}/api/todos/${$}`,{method:"DELETE"})).ok?w():l("Erreur lors de la suppression des tâches terminées")}catch(t){console.error("Erreur clear completed:",t),l("Erreur de connexion")}}async function Re(e){const t=localStorage.getItem("simpleTodo_pseudo")||"",n=typeof window<"u"&&window.userEmail?window.userEmail:T();if(!n){l("Impossible d'assigner la tâche : votre adresse email est introuvable. Veuillez vous reconnecter.");return}let s=t;if(!s&&window.isAuthenticated&&(s=n.split("@")[0],localStorage.setItem("simpleTodo_pseudo",s)),!s){l("Veuillez enregistrer votre pseudo avant de vous assigner une tâche.");return}try{const o=await fetch(`${u}/api/todos/${$}/${e}/assign`,{method:"POST",headers:{"Content-Type":"application/json","X-User-Email":n,"X-User-Pseudo":s},body:JSON.stringify({pseudo:s})});if(o.ok)w();else if(o.status===422){const i=await o.json().catch(()=>null);console.error("Validation assign todo:",i),l(i&&i.message||"Impossible d'assigner la tâche (422)")}else l("Erreur lors de l'assignation de la tâche")}catch(o){console.error("Erreur assign todo:",o),l("Erreur de connexion")}}Object.assign(window,{loadSelectedList:Me,createNewList:_e,requestAuthEmail:Ae,alertBs:l,confirmBs:M,addTodo:de,saveTitle:it,cancelTitleEdit:nt,editTitle:tt,subscribe:X,unsubscribe:at,inviteCollaborator:Ee,addCategory:mt,savePseudo:ue,savePseudoFromModal:me,changeHeaderGradient:ze,saveAutoAssignOption:Ge,deleteCategory:pt,clearCompleted:Je,confirmDeleteList:ot,runServerUpdate:Xe,shareListUrl:rt,toggleTodo:qe,toggleComments:Ke,assignTodo:Re,changeCategory:Qe,changeDueDate:We,deleteTodo:Fe,addComment:ye,resendSubscriberLink:ct,updateCommentBadge:fe});Te();xe();let d=R();V(d);let J=!1,q=!1;if(!d){const t=window.location.pathname.match(/^\/([^\/]+)$/);t&&t[1]&&t[1]!=="index.html"&&(d=t[1],ae(d),V(d))}d||le();function _(){const e=localStorage.getItem("simpleTodo_pseudo"),t=document.getElementById("pseudo");return e&&t?(t.value=e,e):null}function ue(){const e=document.getElementById("pseudo");if(!e)return;const t=e.value.trim();t?(localStorage.setItem("simpleTodo_pseudo",t),O(),new bootstrap.Collapse(document.getElementById("userSettings"),{toggle:!0})):l("Veuillez entrer un pseudo")}function O(){const e=_(),t=f(),n=document.querySelector(".user-pseudo"),s=n?n.querySelector(".user-pseudo-text"):null;n&&s&&e?(s.textContent=e,n.style.display="inline-flex"):n&&(s&&(s.textContent=""),n.style.display="none");const o=document.getElementById("userInfo");if(o&&(o.style.display=e||window.isAuthenticated&&T()?"flex":"none"),t){const i=document.getElementById("emailBadge");i&&(i.style.display="inline-block")}else{const i=document.getElementById("emailBadge");i&&(i.style.display="none")}}const U={gradient1:"linear-gradient(135deg, #8fa4f5 0%, #b491e8 100%)",gradient2:"linear-gradient(135deg, #f66 0%, #ff9240 100%)",gradient3:"linear-gradient(135deg, #56ab2f 0%, #a8e063 100%)",gradient4:"linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)",gradient5:"linear-gradient(135deg, #fd79a8 0%, #e84393 100%)",gradient6:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",gradient7:"linear-gradient(135deg, #fdcb6e 0%, #e17055 100%)",gradient8:"linear-gradient(135deg, #a29bfe 0%, #fd79a8 100%)"};async function Ve(){let e="gradient1";try{const o=await(await fetch(`${u}/api/lists/${d}`)).json();o.header_gradient&&(e=o.header_gradient)}catch(s){console.error("Erreur chargement gradient:",s)}const t=document.querySelector(".card-header");t&&U[e]&&(t.style.background=U[e]);const n=document.getElementById("headerGradient");n&&(n.value=e)}async function ze(){const e=document.getElementById("headerGradient").value,t=document.querySelector(".card-header");if(t&&U[e]){t.style.background=U[e];try{await fetch(`${u}/api/lists/${d}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-Token":window.csrfToken},body:JSON.stringify({header_gradient:e})})}catch(n){console.error("Erreur sauvegarde gradient:",n)}}}async function Ge(){const e=document.getElementById("autoAssignToCreator");if(!e)return;const t=e.checked;window.autoAssignToCreator=t;try{const n=await fetch(`${u}/api/lists/${d}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-Token":window.csrfToken},body:JSON.stringify({auto_assign_to_creator:t})});n.ok||(console.error("Erreur sauvegarde option assignation:",n.statusText),e.checked=!t,window.autoAssignToCreator=!t)}catch(n){console.error("Erreur sauvegarde option assignation:",n),e.checked=!t,window.autoAssignToCreator=!t}}document.addEventListener("DOMContentLoaded",function(){Oe();const e=localStorage.getItem("simpleTodo_pseudo");let t=je();if(d=R(),V(d),t&&d){const i={listId:d,token:t};oe().then(a=>{a&&(i.title=a),localStorage.setItem(`simpleTodo_token_${t}`,JSON.stringify(i))}).catch(a=>{localStorage.setItem(`simpleTodo_token_${t}`,JSON.stringify(i))})}const n=P.get("email");n&&(document.getElementById("email").value=n,localStorage.getItem("simpleTodo_pseudo")&&setTimeout(function(){X()},500)),e||(new bootstrap.Modal(document.getElementById("pseudoModal")).show(),setTimeout(function(){document.getElementById("modalPseudo").focus()},500)),typeof window<"u"&&window.isAuthenticated&&window.userEmail?D(window.userEmail):F(),_(),oe(),Ve(),O(),F(),Q(),w(),W();const s=document.querySelector(".user-pseudo");s&&(s.style.cursor="pointer",s.addEventListener("click",function(){(window.userEmail||f()||"").trim()&&(window.location.href="/")})),setInterval(ut,5e3);const o=document.getElementById("userSettings");o&&o.addEventListener("show.bs.collapse",function(){K()})});async function Xe(){const e=document.getElementById("updateOutput"),t=document.getElementById("updateStatus");e&&(e.textContent="Exécution en cours..."),t&&(t.style.display="block",t.textContent="");try{const n=!!(document.getElementById("updateForce")&&document.getElementById("updateForce").checked),s=await fetch(`${u}/api/update`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":window.csrfToken,"X-User-Email":window.userEmail||f()||""},body:JSON.stringify({email:window.userEmail||f()||"",force:n})}),o=await s.json(),i=[];i.push(`Success: ${!!o.success}`),typeof o.code<"u"&&i.push(`Exit code: ${o.code}`),o.stdout&&(i.push(`
--- stdout ---`),i.push(o.stdout)),o.stderr&&(i.push(`
--- stderr ---`),i.push(o.stderr)),e&&(e.textContent=i.join(`
`)),t&&(t.textContent=s.ok?"Mise à jour terminée.":"Erreur lors de la mise à jour.")}catch(n){e&&(e.textContent=`Erreur: ${n}`),t&&(t.textContent="Erreur lors de la mise à jour.")}}function me(){const e=document.getElementById("modalPseudo").value.trim();if(e){localStorage.setItem("simpleTodo_pseudo",e),O();const t=P.get("email");t&&(document.getElementById("email").value=t,setTimeout(function(){X()},300)),bootstrap.Modal.getInstance(document.getElementById("pseudoModal")).hide()}else l("Veuillez entrer un pseudo")}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("modalPseudo");e&&e.addEventListener("keypress",function(t){t.key==="Enter"&&me()})});function j(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async function We(e){const t=document.querySelector(`[data-id="${e}"]`);if(!t){l("Impossible de récupérer la tâche ciblée. Veuillez recharger la page.");return}const n=t.getAttribute("data-due-date")||"",s=n?new Date(n).toLocaleDateString("fr-FR",{day:"numeric",month:"numeric",year:"numeric"}):"Aucune date",o=document.createElement("div");o.innerHTML=`
        <div class="modal fade" id="dueDateModal" tabindex="-1" aria-labelledby="dueDateModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="dueDateModalLabel"><i class="bi bi-calendar-event"></i> Modifier la date d'échéance</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="newDueDate" class="form-label">Nouvelle date</label>
                            <input type="date" class="form-control" id="newDueDate" value="${n}" min="${new Date().toISOString().split("T")[0]}">
                        </div>
                        <p class="text-muted">Date actuelle : ${s}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" id="removeDueDateBtn">Supprimer la date</button>
                        <button type="button" class="btn btn-primary" id="saveDueDateBtn">Sauvegarder</button>
                    </div>
                </div>
            </div>
        </div>
    `,document.body.appendChild(o);const i=document.getElementById("dueDateModal"),a=new bootstrap.Modal(i);a.show();const r=document.getElementById("newDueDate"),c=document.getElementById("saveDueDateBtn"),m=document.getElementById("removeDueDateBtn"),g=()=>{a.hide(),setTimeout(()=>o.remove(),300)};c.addEventListener("click",async()=>{try{const p=r.value;(await fetch(`${u}/api/todos/${d}/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({due_date:p})})).ok?(g(),w()):l("Erreur lors de la modification de la date d'échéance")}catch(p){console.error("Erreur:",p),l("Erreur lors de la modification de la date d'échéance")}}),m.addEventListener("click",async()=>{try{(await fetch(`${u}/api/todos/${d}/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({due_date:null})})).ok?(g(),w()):l("Erreur lors de la suppression de la date d'échéance")}catch(p){console.error("Erreur:",p),l("Erreur lors de la suppression de la date d'échéance")}})}async function Qe(e){const n=document.querySelector(`[data-id="${e}"]`).dataset.category||"",s=`
        <div class="modal fade" id="categoryModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Changer la catégorie</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <label class="form-label">Catégorie</label>
                        <select id="categorySelect" class="form-select">
                            <option value="">Aucune catégorie</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="button" class="btn btn-primary" onclick="saveCategoryChange(${e})">Sauvegarder</button>
                    </div>
                </div>
            </div>
        </div>
    `,o=document.getElementById("categoryModal");o&&o.remove(),document.body.insertAdjacentHTML("beforeend",s);const i=document.getElementById("categorySelect");i.innerHTML='<option value="">Aucune catégorie</option>',N.forEach(r=>{const c=document.createElement("option");c.value=r.id,c.textContent=r.name,c.style.backgroundColor=r.color,c.style.color="white",r.id==n&&(c.selected=!0),i.appendChild(c)});const a=new bootstrap.Modal(document.getElementById("categoryModal"));a.show(),window.saveCategoryChange=async function(r){const c=i.value||null;try{(await fetch(`${u}/api/todos/${d}/${r}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({category_id:c})})).ok?(a.hide(),setTimeout(()=>document.getElementById("categoryModal").remove(),300),w()):l("Erreur lors du changement de catégorie")}catch(m){console.error("Erreur:",m),l("Erreur lors du changement de catégorie")}}}const Z=document.getElementById("todoInput");Z&&Z.addEventListener("keypress",function(e){e.key==="Enter"&&de()});const ee=document.getElementById("pseudo");ee&&ee.addEventListener("keypress",function(e){e.key==="Enter"&&ue()});const te=document.getElementById("inviteEmail");te&&te.addEventListener("keypress",function(e){e.key==="Enter"&&Ee()});async function Ke(e){const t=document.getElementById(`comments-${e}`);t&&(t.style.display==="none"||t.style.display===""?(t.style.display="block",pe(e)):t.style.display="none")}async function pe(e){try{const[t,n]=await Promise.all([fetch(`${u}/api/comments/${d}/${e}`).then(o=>o.json()),he(e)]),s=ge(t);Ye(e,t),z(e,t.length,n.new_comments,s),s&&await et(e,s)}catch(t){console.error("Erreur lors du chargement des commentaires:",t)}}async function fe(e){try{const[t,n]=await Promise.all([fetch(`${u}/api/comments/${d}/${e}`).then(i=>i.json()),he(e)]),s=document.getElementById(`comment-badge-${e}`),o=ge(t);if(!s)return;we(s,t.length),z(e,t.length,n.new_comments,o)}catch(t){console.error("Erreur lors du chargement du badge:",t)}}function Ye(e,t){const n=document.getElementById(`comments-list-${e}`);if(t.length===0){n.innerHTML='<div class="text-muted small">Aucun commentaire</div>',z(e,0,0,0),ne(e);return}n.innerHTML=t.map(s=>{const o=s.created_at?dt(s.created_at):"";return`
        <div class="comment-item">
            <div class="comment-pseudo">${j(s.pseudo)}</div>
            <div>${j(s.text)}</div>
            ${o?`<div class="text-muted small fst-italic mt-1">${o}</div>`:""}
        </div>
        `}).join(""),ne(e)}function ge(e){return!Array.isArray(e)||e.length===0?0:e.reduce((t,n)=>{const s=Number(n==null?void 0:n.id)||0;return s>t?s:t},0)}async function ye(e){const t=document.getElementById(`comment-input-${e}`);if(!t)return;const n=t.value.trim(),s=_();if(!n){l("Veuillez entrer un commentaire");return}if(!s){l("Veuillez d'abord entrer votre pseudo");return}try{(await fetch(`${u}/api/comments/${d}/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:n,pseudo:s})})).ok&&(t.value="",pe(e),fe(e))}catch(o){console.error("Erreur:",o),l("Erreur lors de l'ajout du commentaire")}}function ne(e){const t=document.getElementById(`comment-input-${e}`);!t||t.dataset.enterHandler==="true"||(t.addEventListener("keydown",n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),ye(e))}),t.dataset.enterHandler="true")}async function be(){const e=(window.adminEmail||"").toLowerCase(),t=(window.userEmail||f()||"").trim().toLowerCase();if(!(!e||!t||e!==t)&&!(J||q)){q=!0;try{const n=await fetch(`${u}/api/update/check`);if(!n.ok)return;const s=await n.json();if(!s.success||(J=!0,!s.has_update))return;const o=document.getElementById("updateLinkContainer"),i=document.getElementById("updateLink");if(!o||!i)return;const a=[];s.remote_tag&&a.push(s.remote_tag),s.remote_name&&a.push(s.remote_name);const r=a.join(" - ");i.textContent=r?`Mettre à jour l'application (${r})`:"Mettre à jour l'application",i.classList.remove("d-none"),o.classList.remove("d-none")}catch(n){console.error("Erreur lors de la vérification de mise à jour:",n)}finally{q=!1}}}function Ze(e,t){const n=document.getElementById(`comment-button-${e}`);n&&(n.classList.remove("btn-outline-secondary","btn-outline-primary"),t>0?n.classList.add("btn-outline-primary"):n.classList.add("btn-outline-secondary"))}function z(e,t,n,s){Ze(e,t);const o=document.getElementById(`comment-new-badge-${e}`);o&&(we(o,n),o.dataset.lastCommentId=String(s||""))}async function et(e,t){const n=f();if(!n||!d||!t)return 0;try{const s=await fetch(`${u}/api/subscribers/${d}/todos/${e}/last-comment`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:n,comment_id:t})});if(!s.ok)return 0;const o=await s.json();return Number((o==null?void 0:o.new_comments)||0)}catch(s){return console.error("Erreur lors de la mise à jour du dernier commentaire consulté:",s),0}}async function he(e){const t=f();if(!t||!d)return{stored_comment_id:0,new_comments:0};try{const n=await fetch(`${u}/api/subscribers/${d}/todos/${e}/last-comment?email=${encodeURIComponent(t)}`);return n.ok?await n.json():{stored_comment_id:0,new_comments:0}}catch(n){return console.error("Erreur lors de la récupération du dernier commentaire consulté:",n),{stored_comment_id:0,new_comments:0}}}function we(e,t){e&&(e.textContent=t>0?t:"",e.classList.toggle("d-none",t===0))}async function oe(){const e=P.get("title");let t="SimpleTodo";if(e){t=decodeURIComponent(e),document.getElementById("listTitle").textContent=t,localStorage.setItem(`simpleTodo_list_${d}`,JSON.stringify({listId:d,title:t}));const o=f();try{if(await fetch(`${u}/api/lists/${d}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t,creator_email:o})}),o){window.isListCreator=!0,console.log("isListCreator set to true (new list creation)"),D(o);try{const i=_()||"Créateur";await fetch(`${u}/api/subscribers/${d}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:o,pseudo:i})})}catch(i){console.error("Erreur abonnement auto:",i)}}}catch(i){console.error("Erreur sauvegarde liste:",i)}return se(),be(),t}const n=f(),s=n?`${u}/api/lists/${d}?email=${encodeURIComponent(n)}`:`${u}/api/lists/${d}`;try{const i=await(await fetch(s)).json();t=i.title||"SimpleTodo",window.isListCreator=i.is_creator,window.isSubscriber=i.is_subscriber||!1,window.autoAssignToCreator=i.auto_assign_to_creator||!1,window.adminEmail=(i.admin_email||"").toLowerCase(),console.log("isListCreator from API:",window.isListCreator),console.log("isSubscriber from API:",window.isSubscriber),console.log("autoAssignToCreator from API:",window.autoAssignToCreator),console.log("Creator email from API:",i.creator_email),window.isListCreator&&!f()&&i.creator_email&&(D(i.creator_email),console.log("Creator email set from API:",i.creator_email));const a=document.getElementById("autoAssignToCreator");a&&(a.checked=window.autoAssignToCreator),se(),G();const r=document.getElementById("listTitle");r&&(r.textContent=t)}catch(o){console.error("Erreur lors du chargement du titre:",o);const i=document.getElementById("listTitle");i&&(i.textContent="SimpleTodo")}return t}function tt(){const e=document.getElementById("titleInput"),t=document.getElementById("titleField");t.value=document.getElementById("listTitle").textContent,e.style.display="block"}function nt(){document.getElementById("titleInput").style.display="none"}function se(){console.log("updateDeleteButton called, isListCreator:",window.isListCreator);const e=document.getElementById("deleteListBtnSettings");e&&window.isListCreator?e.classList.remove("d-none"):e&&e.classList.add("d-none");const t=document.querySelectorAll(".creator-only");console.log("Found",t.length,"creator-only sections"),t.forEach(o=>{window.isListCreator?(o.classList.add("show"),o.classList.remove("d-none")):(o.classList.remove("show"),o.classList.add("d-none"))});const n=document.getElementById("updateLinkContainer"),s=document.getElementById("updateLink");window.isListCreator?(n&&n.classList.add("d-none"),s&&s.classList.add("d-none"),be()):(n&&n.classList.add("d-none"),s&&s.classList.add("d-none"),J=!1)}async function ot(){await M(`Attention : Cette action est irréversible !

Voulez-vous vraiment supprimer cette liste et toutes ses tâches ?`)&&await st()}async function st(){const e=f();if(!e){l("Erreur : Email non trouvé");return}try{const t=`${u}/api/lists/${d}?email=${encodeURIComponent(e)}`,n=await fetch(t,{method:"DELETE"});if(n.ok)l("Liste supprimée avec succès"),le();else{const s=await n.json();l(s.error||"Erreur lors de la suppression de la liste")}}catch(t){console.error("Erreur:",t),l("Erreur lors de la suppression de la liste")}}async function it(){const t=document.getElementById("titleField").value.trim();if(!t){l("Veuillez entrer un titre");return}try{const n=f(),s=n?`${u}/api/lists/${d}?email=${encodeURIComponent(n)}`:`${u}/api/lists/${d}`;(await fetch(s,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t})})).ok?(document.getElementById("listTitle").textContent=t,document.getElementById("titleInput").style.display="none"):l("Erreur lors de la sauvegarde du titre")}catch(n){console.error("Erreur:",n),l("Erreur lors de la sauvegarde du titre")}}function rt(){if(!d){l("Aucune liste sélectionnée");return}const t=`${window.location.origin}/?list=${d}`;navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(t).then(()=>{l(`Lien copié dans le presse-papiers !

`+t)}).catch(n=>{console.error("Erreur lors de la copie:",n),ie(t)}):ie(t)}function ie(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy"),l(`Lien copié dans le presse-papiers !

`+e)}catch(n){console.error("Erreur lors de la copie:",n),prompt("Copiez ce lien manuellement:",e)}document.body.removeChild(t)}function G(){const e=f(),t=document.getElementById("emailSubscription"),n=document.getElementById("emailUnsubscribe"),s=document.getElementById("emailDisplay");if(!e){t&&(t.style.display="block"),n&&(n.style.display="none");return}window.isSubscriber?(s&&(s.textContent=e),n&&(n.style.display="block"),t&&(t.style.display="none")):(s&&(s.textContent=""),t&&(t.style.display="block"),n&&(n.style.display="none"))}async function X(){const e=document.getElementById("email"),t=e.value.trim();if(!t||!t.includes("@"))return;const n=_();try{(await fetch(`${u}/api/subscribers/${d}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,pseudo:n})})).ok&&(D(t),e.value="",window.isSubscriber=!0,G(),O(),W())}catch(s){console.error("Erreur:",s),l("Erreur lors de l'inscription")}}async function at(){const e=f();if(e)try{(await fetch(`${u}/api/subscribers/${d}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})})).ok&&(document.getElementById("email").value="",window.isSubscriber=!1,G(),O(),W())}catch(t){console.error("Erreur:",t),l("Erreur lors de la désinscription")}}async function W(){try{const t=await(await fetch(`${u}/api/subscribers/${d}`)).json();await lt(t)}catch(e){console.error("Erreur:",e);const t=document.getElementById("subscribersList");t&&(t.innerHTML='<div class="text-white small text-center py-2">Erreur de chargement</div>')}}async function lt(e){const t=document.getElementById("subscribersList");if(!t)return;if(e.length===0){t.innerHTML='<div class="text-white small text-center py-2"><i class="bi bi-inbox"></i> Aucun abonné pour le moment</div>';return}let n=null;console.log("displaySubscribers - isListCreator:",window.isListCreator);try{const s=f(),o=s?`${u}/api/lists/${d}?email=${encodeURIComponent(s)}`:`${u}/api/lists/${d}`,a=await(await fetch(o)).json();n=a.creator_email,console.log("Creator email from API:",n),a.is_creator!==void 0&&(window.isListCreator=a.is_creator,console.log("isListCreator from API:",window.isListCreator))}catch(s){console.error("Erreur récupération email créateur:",s)}t.innerHTML=e.map(s=>{const o=n&&n.trim()===s.email.trim();return console.log("Subscriber:",s.email,"Creator email:",n,"isCreator:",o),`
        <div class="d-flex align-items-center justify-content-between py-1">
            <div>
                <small class="text-white">
                    ${o?'<i class="bi bi-star-fill text-warning me-1" title="Créateur"></i>':""}
                    ${j(s.pseudo||s.email)} 
                    ${s.pseudo?`<span class="text-white">(${j(s.email)})</span>`:""}
                </small>
            </div>
            <button class="btn btn-sm btn-light" onclick="resendSubscriberLink(${s.id})" title="Renvoyer le lien">
                <i class="bi bi-send"></i>
            </button>
        </div>
        `}).join("")}async function ct(e){try{(await fetch(`${u}/api/subscribers/${d}/${e}/resend`,{method:"POST",headers:{"Content-Type":"application/json"}})).ok}catch(t){console.error("Erreur:",t)}}async function Ee(){const e=document.getElementById("inviteEmail"),t=e.value.trim();if(!t||!t.includes("@"))return;const n=_();try{(await fetch(`${u}/api/invitations/${d}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,invited_by:n||"Quelqu'un"})})).ok&&(e.value="")}catch(s){console.error("Erreur:",s)}}function dt(e){const t=new Date(e),s=new Date-t;if(s<6e4)return"À l'instant";if(s<36e5){const o=Math.floor(s/6e4);return`Il y a ${o} minute${o>1?"s":""}`}if(s<864e5){const o=Math.floor(s/36e5);return`Il y a ${o} heure${o>1?"s":""}`}if(s<6048e5){const o=Math.floor(s/864e5);return`Il y a ${o} jour${o>1?"s":""}`}return t.toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}let N=[];async function Q(){try{N=await(await fetch(`${u}/api/categories/${d}`)).json()}catch(e){console.error("Erreur lors du chargement des catégories:",e)}}async function ut(){try{const e=await fetch(`${u}/api/email-queue/process`,{method:"POST"});if(e.ok){const t=await e.json();t.processed>0&&console.log(`Emails traités: ${t.sent} envoyés, ${t.failed} échoués`)}}catch{}}async function K(){const e=document.getElementById("categoriesContainer");if(e.innerHTML="",N.length===0){e.innerHTML='<div class="text-muted text-white small">Aucune catégorie</div>';return}N.forEach(t=>{const n=document.createElement("div");n.className="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom border-white",n.innerHTML=`
            <div class="d-flex align-items-center">
                <span class="badge rounded-pill me-2" style="background-color: ${t.color}; color: white;">
                    ${j(t.name)}
                </span>
            </div>
            <button class="btn btn-sm btn-outline-light" onclick="deleteCategory(${t.id})">
                <i class="bi bi-trash"></i>
            </button>
        `,e.appendChild(n)})}async function mt(){const e=document.getElementById("newCategoryName").value.trim(),t=document.getElementById("newCategoryColor").value;if(!e){l("Veuillez entrer un nom de catégorie");return}try{(await fetch(`${u}/api/categories/${d}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,color:t})})).ok&&(document.getElementById("newCategoryName").value="",Q(),K())}catch(n){console.error("Erreur:",n),l("Erreur lors de l'ajout de la catégorie")}}async function pt(e){if(await M("Supprimer cette catégorie ?"))try{(await fetch(`${u}/api/categories/${d}/${e}`,{method:"DELETE"})).ok&&(Q(),K())}catch(n){console.error("Erreur:",n)}}
