const Ee={title:"Information",closeLabel:"Fermer",okLabel:"Ok",backdrop:!0,keyboard:!0},ve={title:"Confirmer",closeLabel:"Annuler",cancelLabel:"Annuler",confirmLabel:"Confirmer",backdrop:!0,keyboard:!0};function $e({title:e,closeLabel:t,okLabel:n}){const s=document.createElement("div");return s.className="modal fade",s.id="alertBsModal",s.tabIndex=-1,s.setAttribute("aria-labelledby","alertBsModalLabel"),s.setAttribute("aria-hidden","true"),s.innerHTML=`
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertBsModalLabel">${e}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="${t}"></button>
                </div>
                <div class="modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary btn-alert-ok">${n}</button>
                </div>
            </div>
        </div>
    `,s}function l(e,t={}){var c,m,g;if(!((c=window.bootstrap)!=null&&c.Modal)){(m=window.alert)==null||m.call(window,e);return}const n={...Ee,...t},s=document.getElementById("alertBsModal");if(s){const p=(g=window.bootstrap)==null?void 0:g.Modal.getInstance(s);p&&p.hide(),s.remove()}const o=$e(n);o.querySelector(".modal-body").innerHTML=typeof e=="string"?e.replace(/\n/g,"<br>"):e,document.body.appendChild(o);const i=new window.bootstrap.Modal(o,{backdrop:n.backdrop,keyboard:n.keyboard}),r=()=>{o.removeEventListener("hidden.bs.modal",r),o.remove()};o.addEventListener("hidden.bs.modal",r,{once:!0});const a=o.querySelector(".btn-alert-ok");a==null||a.addEventListener("click",()=>i.hide(),{once:!0}),i.show()}function Ce({title:e,closeLabel:t,confirmLabel:n,cancelLabel:s}){const o=document.createElement("div");return o.className="modal fade",o.id="confirmBsModal",o.tabIndex=-1,o.setAttribute("aria-labelledby","confirmBsModalLabel"),o.setAttribute("aria-hidden","true"),o.innerHTML=`
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmBsModalLabel">${e}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="${t}"></button>
                </div>
                <div class="modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-confirm-cancel">${s}</button>
                    <button type="button" class="btn btn-danger btn-confirm-ok">${n}</button>
                </div>
            </div>
        </div>
    `,o}function S(e,t={}){var r,a;if(!((r=window.bootstrap)!=null&&r.Modal)){const c=window.confirm?window.confirm(e):!0;return Promise.resolve(c)}const n={...ve,...t},s=document.getElementById("confirmBsModal");if(s){const c=(a=window.bootstrap)==null?void 0:a.Modal.getInstance(s);c&&c.hide(),s.remove()}const o=Ce(n);o.querySelector(".modal-body").innerHTML=typeof e=="string"?e.replace(/\n/g,"<br>"):e,document.body.appendChild(o);const i=new window.bootstrap.Modal(o,{backdrop:n.backdrop,keyboard:n.keyboard});return new Promise(c=>{var T,x;let m=!1;const g=()=>{var v,I;o.removeEventListener("hidden.bs.modal",p),(v=o.querySelector(".btn-confirm-ok"))==null||v.removeEventListener("click",b),(I=o.querySelector(".btn-confirm-cancel"))==null||I.removeEventListener("click",L),o.remove()},p=()=>{m||(m=!0,c(!1)),g()},b=()=>{m||(m=!0,c(!0)),i.hide()},L=()=>{m||(m=!0,c(!1)),i.hide()};o.addEventListener("hidden.bs.modal",p,{once:!0}),(T=o.querySelector(".btn-confirm-ok"))==null||T.addEventListener("click",b,{once:!0}),(x=o.querySelector(".btn-confirm-cancel"))==null||x.addEventListener("click",L,{once:!0}),i.show()})}window.alertBs=l;window.confirmBs=S;const u="",j=new URLSearchParams(window.location.search);let se=j.get("list")||null;function F(){return se}function ie(e){se=e}function Ie(){const e=document.querySelector('meta[name="app:auth"]');let t="",n="",s=null,o=!1;if(e){const a=e.dataset;a&&(t=(a.email||"").trim(),n=(a.sessionEmail||"").trim(),s=a.name||null,o=a.authenticated==="1")}const i=document.querySelector('meta[name="csrf-token"]');i&&(window.csrfToken=i.getAttribute("content"));const r=t||n||"";window.authUser={email:r||null,name:s,isAuthenticated:o},window.userEmail=r,window.isAuthenticated=o,window.sessionEmail=n}function Le(){if(typeof window>"u"||typeof window.fetch!="function"||window.fetch.__isAuthenticatedWrapper)return;const e=window.fetch.bind(window);window.fetch=(t,n={})=>{const s={...n};s.credentials=s.credentials||"include";const o=new Headers(s.headers||{});if(o.has("Accept")||o.set("Accept","application/json"),window.csrfToken&&!o.has("X-CSRF-Token")){const i=(s.method||"GET").toUpperCase();i!=="GET"&&i!=="HEAD"&&o.set("X-CSRF-Token",window.csrfToken)}return s.headers=o,e(t,s)},window.fetch.__isAuthenticatedWrapper=!0}function f(){const e=localStorage.getItem("simpleTodo_email");return e?e.trim():""}function A(e){const t=(e||"").trim();t?(localStorage.setItem("simpleTodo_email",t),typeof window<"u"&&(window.userEmail=t)):(localStorage.removeItem("simpleTodo_email"),typeof window<"u"&&(window.userEmail="")),U()}function B(){let e="";if(typeof window<"u"&&window.userEmail&&typeof window.userEmail=="string"&&window.userEmail.trim()!==""&&(e=window.userEmail.trim()),!e){const t=f();t&&(e=t)}return e}function U(){const e=document.querySelectorAll(".user-email");if(!e.length)return;const t=!!(typeof window<"u"&&window.isAuthenticated),n=B();e.forEach(s=>{const o=s.querySelector(".user-email-text");o&&(t&&n?(o.textContent=n,s.style.display="inline-flex",typeof window<"u"&&(window.userEmail=n,window.authUser||(window.authUser={}),window.authUser.email=n,window.authUser.isAuthenticated=!0)):(o.textContent="",s.style.display="none"))})}function Te(){return"list_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function re(){const e=B(),t=e?`<span class="badge bg-light text-dark" style="font-size: 0.85rem;">${e}</span>`:"",n=e?`-- Sélectionner une liste pour ${e} --`:"-- Sélectionner une liste --",s=e||"";document.body.innerHTML=`
        <div class="container" style="max-width: 600px; margin: 100px auto;">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #8fa4f5 0%, #b491e8 100%); color: white;">
                    <div class="d-flex align-items-center justify-content-between">
                        <h2 class="mb-0"><i class="bi bi-check2-square"></i> SimpleTodo</h2>
                        ${t}
                    </div>
                </div>
                <div class="card-body">
                    <h5 class="mb-4">Choisir ou créer une liste</h5>
                    
                    <div class="mb-4">
                        <label class="form-label">Mes listes</label>
                        <select id="myLists" class="form-select mylists-select">
                            <option value="">${n}</option>
                        </select>
                        <button class="btn btn-primary w-100 mt-2" onclick="loadSelectedList()">
                            <i class="bi bi-box-arrow-in-right"></i> Ouvrir cette liste
                        </button>
                    </div>
                    
                    <hr>
                    
                    <div>
                        <label class="form-label">Créer une nouvelle liste</label>
                        <input type="text" id="newListTitle" class="form-control mb-2" placeholder="Nom de la liste" maxlength="100">
                        <input type="email" id="newListEmail" class="form-control mb-2" placeholder="Votre email (pour être le créateur)" maxlength="255" value="${s}">
                        <small class="text-muted d-block mb-2">Votre email vous donnera les droits de créateur (modifier le thème, supprimer la liste)</small>
                        <button class="btn btn-success w-100" onclick="createNewList()">
                            <i class="bi bi-plus-circle"></i> Créer une nouvelle liste
                        </button>
                    </div>
                    
                    <hr>
                    
                    <div>
                        <label class="form-label">Recevoir un email d'authentification</label>
                        <input type="email" id="authEmail" class="form-control mb-2" placeholder="Votre email" maxlength="255">
                        <small class="text-muted d-block mb-2">Un lien d'authentification vous sera envoyé par email</small>
                        <button class="btn btn-info w-100" onclick="requestAuthEmail()">
                            <i class="bi bi-envelope"></i> Envoyer l'email
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `,ke()}async function xe(){const e=[],t=B(),n=t?`-- Sélectionner une liste pour ${t} --`:"-- Sélectionner une liste --";try{const o=await fetch(`${u}/api/mylists`);o.ok?(await o.json()).forEach(r=>{e.push({listId:r.id,title:r.title})}):console.log("Erreur lors du chargement des listes depuis l'API:",o.status)}catch(o){console.error("Erreur lors du chargement des listes depuis l'API:",o)}for(let o=0;o<localStorage.length;o++){const i=localStorage.key(o);if(i.startsWith("simpleTodo_list_")){const r=localStorage.getItem(i),a=JSON.parse(r);a&&a.listId&&(e.find(m=>m.listId===a.listId)||e.push({listId:a.listId,title:a.title||a.listId}))}}return document.querySelectorAll(".mylists-select").forEach(o=>{o.innerHTML=`<option value="">${n}</option>`,e.forEach(i=>{const r=document.createElement("option");r.value=i.listId,r.textContent=i.title,o.appendChild(r)}),e.length===0&&(o.innerHTML='<option value="">Aucune liste disponible</option>')}),e}function ke(){xe()}async function Se(){const e=document.getElementById("myLists");if(!e)return;const t=e.value;if(t)try{const n=await fetch(`${u}/api/lists/${t}`);if(!n.ok||n.status===404){localStorage.removeItem(`simpleTodo_list_${t}`);for(let s=localStorage.length-1;s>=0;s--){const o=localStorage.key(s);if(o&&o.startsWith("simpleTodo_token_")){const i=JSON.parse(localStorage.getItem(o));i&&i.listId===t&&localStorage.removeItem(o)}}l("Cette liste n'existe plus. Retour à l'accueil."),window.location.href="/";return}window.location.href=`/${t}`}catch(n){console.error("Erreur lors de la vérification de la liste:",n),l("Erreur lors de la vérification de la liste.")}}async function Be(){const e=document.getElementById("newListTitle"),t=document.getElementById("newListEmail");if(!e)return;const n=e.value.trim();if(!n){l("Veuillez entrer un nom pour la liste");return}const o=(t?t.value.trim():"")||f();if(!o){l("Veuillez entrer votre email pour devenir le créateur de la liste"),t&&t.focus();return}f()||A(o);const i=Te();try{(await fetch(`${u}/api/lists/${i}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:n,creator_email:o})})).ok?window.location.href=`/${i}`:l("Erreur lors de la création de la liste")}catch(r){console.error("Erreur:",r),l("Erreur de connexion lors de la création de la liste")}}async function Me(){const e=document.getElementById("authEmail");if(!e)return;const t=e.value.trim();if(!t||!t.includes("@")){l("Veuillez entrer une adresse email valide");return}try{const n=await fetch(`${u}/api/auth/request-email`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t})});if(n.ok)l("Un email avec vos liens d'authentification a été envoyé !"),e.value="";else{const s=await n.json();l(s.message||"Erreur lors de l'envoi de l'email")}}catch(n){console.error("Erreur:",n),l("Erreur de connexion")}}function _e(){const t=window.location.pathname.match(/^\/([^\/]+)\/([^\/]+)$/);if(t){const n=t[1];return ie(n),{listId:n,token:t[2]}}return null}function Ae(){let e=j.get("token");if(e)return e;const t=_e();return t?t.token:null}let C=F(),k=null;function J(e){C=e}function De(e){switch((e||"medium").toLowerCase()){case"high":return"danger";case"low":return"secondary";default:return"primary"}}function je(){const e=document.getElementById("mistralGenerateBtn"),t=document.getElementById("mistralImportBtn"),n=document.getElementById("mistralModal");if(!e||!n)return;const s=e.innerHTML,o=document.getElementById("mistralPrompt"),i=document.getElementById("mistralMaxItems"),r=document.getElementById("mistralDeadline"),a=document.getElementById("mistralAlert"),c=document.getElementById("mistralStatus"),m=document.getElementById("mistralResultWrapper"),g=document.getElementById("mistralResultTitle"),p=document.getElementById("mistralResultSummary"),b=document.getElementById("mistralResultItems"),L=()=>{k=null,a&&(a.classList.add("d-none"),a.textContent=""),c&&(c.classList.add("d-none"),c.classList.remove("text-success","text-danger"),c.classList.add("text-muted"),c.textContent=""),m&&(m.classList.add("d-none"),g.textContent="",p.textContent="",b.innerHTML=""),r&&(r.value=""),e.disabled=!1,e.innerHTML=s,t&&(t.disabled=!0)};n.addEventListener("shown.bs.modal",()=>{L(),o==null||o.focus()});const T=async()=>{if(!o||!i||!a||!m||!g||!p||!b)return;const v=o.value.trim(),I=parseInt(i.value,10),_=r!=null&&r.value?r.value:null;if(v===""){a.textContent="Veuillez décrire ce que vous souhaitez générer.",a.classList.remove("d-none");return}a.classList.add("d-none"),m.classList.add("d-none"),e.disabled=!0,e.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Génération en cours…',c&&(c.classList.remove("d-none","text-success","text-danger"),c.classList.add("text-muted"),c.innerHTML='<i class="bi bi-hourglass-split me-1"></i>Génération en cours…');try{const $=await fetch(`${u}/api/mistral/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:v,max_items:Number.isNaN(I)?void 0:I,deadline:_,list_id:C})});if(!$.ok){const y=await $.json().catch(()=>null);throw new Error((y==null?void 0:y.message)||"Erreur lors de la génération.")}const h=await $.json();k=h,g.textContent=h.title||"Liste générée",p.textContent=h.summary||"",p.style.display=h.summary?"block":"none",Array.isArray(h.items)&&h.items.length?b.innerHTML=h.items.map((y,we)=>`
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <span class="fw-semibold">${w(y.title||`Tâche ${we+1}`)}</span>
                            <span class="badge bg-${De(y.priority)} text-uppercase">${y.priority||"medium"}</span>
                        </div>
                        ${y.description?`<p class="mb-1">${w(y.description)}</p>`:""}
                        <div class="text-muted small d-flex flex-wrap gap-3">
                            ${y.category?`<span><i class="bi bi-tag"></i> ${w(y.category)}</span>`:""}
                            ${y.due_date?`<span><i class="bi bi-calendar-event"></i> ${w(y.due_date)}</span>`:""}
                        </div>
                    </li>
                `).join(""):b.innerHTML=`
                    <li class="list-group-item text-muted text-center">
                        <i class="bi bi-info-circle"></i> Aucune tâche générée.
                    </li>
                `,m.classList.remove("d-none"),t&&(t.disabled=!1),c&&(c.classList.remove("text-muted","text-danger"),c.classList.add("text-success"),c.innerHTML='<i class="bi bi-check-circle me-1"></i>Génération terminée.')}catch($){console.error("[Mistral] Generation error:",$),a.textContent=$ instanceof Error?$.message:"Erreur inattendue.",a.classList.remove("d-none"),c&&(c.classList.remove("text-muted","text-success"),c.classList.add("text-danger"),c.innerHTML='<i class="bi bi-exclamation-triangle me-1"></i>Erreur lors de la génération.')}finally{e.disabled=!1,e.innerHTML=s}},x=async()=>{if(!k||!Array.isArray(k.items)||!k.items.length){l("Aucune tâche à importer.");return}try{const v=localStorage.getItem("simpleTodo_pseudo")||"Mistral",I=B();t&&(t.disabled=!0,t.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Import en cours...');for(const[$,h]of k.items.entries()){const y={text:h.title||`Tâche générée ${$+1}`,pseudo:v,description:h.description||null,due_date:h.due_date||null,priority:h.priority||"medium",category_name:h.category||null,source:"mistral"};await fetch(`${u}/api/todos/${C}`,{method:"POST",headers:{"Content-Type":"application/json",...I?{"X-User-Email":I}:{}},body:JSON.stringify(y)})}E(),l("Tâches importées avec succès depuis Mistral."),t&&(t.disabled=!1,t.innerHTML='<i class="bi bi-plus-circle"></i> Importer dans la liste');const _=bootstrap.Modal.getInstance(n);_==null||_.hide()}catch(v){console.error("[Mistral] Import error:",v),l("Erreur lors de l'import des tâches générées."),t&&(t.disabled=!1,t.innerHTML='<i class="bi bi-plus-circle"></i> Importer dans la liste');return}t&&(t.innerHTML='<i class="bi bi-plus-circle"></i> Importer dans la liste')};e.addEventListener("click",T),t&&t.addEventListener("click",x)}async function E(){try{const t=await(await fetch(`${u}/api/todos/${C}`)).json();Pe(t),He(t)}catch(e){console.error("Erreur lors du chargement des todos:",e)}}function Pe(e){const t=document.getElementById("todoList");if(!t)return;if(!e.length){t.innerHTML=`
            <div class="text-center text-muted py-5">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-3">Aucune tâche pour le moment</p>
            </div>
        `;return}const n=new Map,s=[];e.forEach(i=>{if(i.category){const r=`cat_${i.category.id}`;n.has(r)||n.set(r,{name:i.category.name,color:i.category.color,nextDate:i.category.next_date||null,todos:[]});const a=n.get(r);i.category.next_date&&(!a.nextDate||i.category.next_date<a.nextDate)&&(a.nextDate=i.category.next_date),a.todos.push(i)}else s.push(i)});let o="";s.length&&(o+=`
            <div class="mb-3">
                ${s.map(i=>Q(i)).join("")}
            </div>
        `),n.size&&(o+='<div class="accordion" id="todoAccordion">',Array.from(n.entries()).sort((r,a)=>{const c=r[1].nextDate||null,m=a[1].nextDate||null;if(c&&m){const b=new Date(c)-new Date(m);if(b!==0)return b}else{if(c&&!m)return-1;if(!c&&m)return 1}const g=r[1].name.toLowerCase(),p=a[1].name.toLowerCase();return g.localeCompare(p,"fr")}).forEach(([r,a],c)=>{const m=`collapse_${r}`,g=`heading_${r}`,p=c===0&&!s.length,b=a.color||"#6c757d",L=a.todos.map(x=>Q(x)).join(""),T=Oe(a.nextDate)||"";o+=`
                <div class="accordion-item">
                    <h2 class="accordion-header" id="${g}">
                        <button class="accordion-button ${p?"":"collapsed"}" type="button"
                            data-bs-toggle="collapse" data-bs-target="#${m}"
                            aria-expanded="${p?"true":"false"}" aria-controls="${m}">
                            <span class="badge rounded-pill me-2" style="background-color: ${b}; color: #fff;">
                                ${w(a.name)}
                            </span>
                            <span class="ms-1 text-muted">${a.todos.length} tâche${a.todos.length>1?"s":""}</span>
                            ${T}
                        </button>
                    </h2>
                    <div id="${m}" class="accordion-collapse collapse ${p?"show":""}"
                        aria-labelledby="${g}" data-bs-parent="#todoAccordion">
                        <div class="accordion-body p-0">
                            ${L}
                        </div>
                    </div>
                </div>
            `}),o+="</div>"),t.innerHTML=o,window.updateCommentBadge&&e.forEach(i=>{window.updateCommentBadge(i.id)})}function Q(e){const t=e.comments?e.comments.length:0,n=e.due_date?ae(e.due_date):"Aucune date",s=e.completed?"bi-arrow-counterclockwise":"bi-check-lg",o=e.completed?"Marquer comme non terminé":"Marquer comme terminé",i=e.completed?"btn btn-sm btn-outline-success flex-shrink-0":"btn btn-sm btn-outline-primary flex-shrink-0",r=e.pseudo?`<span class="badge bg-light text-dark pseudo-badge ms-2"><i class="bi bi-person-fill"></i> ${w(e.pseudo)}</span>`:"",a=e.assigned_to?`<span class="badge bg-info text-dark pseudo-badge ms-2"><i class="bi bi-person-check"></i> ${w(e.assigned_to)}</span>`:"",c=t>0?"btn btn-sm btn-outline-primary":"btn btn-sm btn-outline-secondary";return`
        <div class="todo-item ${e.completed?"completed":""}" data-id="${e.id}" data-category="${e.category?e.category.id:""}" data-assigned="${e.assigned_to?w(e.assigned_to):""}" data-due-date="${e.due_date||""}" data-completed="${e.completed?"1":"0"}">
            <div class="d-flex align-items-start gap-2">
                <button class="${i}" title="${o}"
                    onclick="event.stopPropagation(); toggleTodo(${e.id})">
                    <i class="bi ${s}"></i>
                </button>
                <div class="flex-grow-1">
                    <div>
                        <span class="todo-text ${e.completed?"completed":""}">${w(e.text)}</span>
                        ${e.completed?'<span class="badge bg-success ms-2"><i class="bi bi-check-circle"></i> Terminé</span>':""}
                        ${r}
                        ${a}
                    </div>
                    <div class="text-muted" style="font-size: 0.85rem;">
                        Ajouté par <strong>${w(e.pseudo||"Anonyme")}</strong>
                        • ${n}
                    </div>
                </div>
                <div class="d-flex gap-2 flex-shrink-0">
                    <button id="comment-button-${e.id}" class="${c} btn-comment-wrapper" title="Afficher les commentaires"
                        onclick="event.stopPropagation(); toggleComments(${e.id})">
                        <i class="bi bi-chat-dots"></i>
                        <span class="comment-badge" id="comment-badge-${e.id}" ${t>0?"":'style="display:none;"'}>${t}</span>
                        <span class="comment-badge comment-badge-new d-none" id="comment-new-badge-${e.id}"></span>
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                            id="dropdownMenuButton${e.id}" data-bs-toggle="dropdown" aria-expanded="false"
                            onclick="event.stopPropagation();">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton${e.id}">
                            ${e.assigned_to?"":`<li><a class="dropdown-item" href="#" onclick="event.stopPropagation(); assignTodo(${e.id}); return false;"><i class="bi bi-person-plus me-2"></i>Je m'en occupe</a></li>`}
                            <li><a class="dropdown-item" href="#" onclick="event.stopPropagation(); changeCategory(${e.id}); return false;"><i class="bi bi-tag me-2"></i>Changer de catégorie</a></li>
                            <li><a class="dropdown-item" href="#" onclick="event.stopPropagation(); changeDueDate(${e.id}); return false;"><i class="bi bi-calendar-plus me-2"></i>Modifier la date</a></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="event.stopPropagation(); deleteTodo(${e.id}); return false;"><i class="bi bi-trash me-2"></i>Supprimer</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="comments-section" id="comments-${e.id}" style="display: none;">
                <div class="comment-list" id="comments-list-${e.id}"></div>
                <div class="comment-form input-group mt-2">
                    <input type="text" class="form-control" id="comment-input-${e.id}" placeholder="Ajouter un commentaire...">
                    <button class="btn btn-outline-primary" type="button" onclick="addComment(${e.id})">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
        </div>
    `}function w(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function ae(e){return new Date(e).toLocaleDateString("fr-FR",{year:"numeric",month:"long",day:"numeric"})}function Oe(e){if(!e)return null;const t=new Date;t.setHours(0,0,0,0);const n=new Date(e);n.setHours(0,0,0,0);const s=Math.round((n-t)/864e5);let o="badge ms-auto text-uppercase",i="bi-calendar-event";return s<=0?(o+=" bg-danger",i="bi-exclamation-octagon"):s<=7?(o+=" bg-warning text-dark",i="bi-exclamation-triangle"):o+=" bg-primary",`<span class="${o}"><i class="bi ${i} me-1"></i>${w(ae(e))}</span>`}function He(e){const t=e.length,n=e.filter(a=>a.completed).length,s=t-n,o=document.getElementById("totalCount"),i=document.getElementById("completedCount"),r=document.getElementById("remainingCount");o&&(o.textContent=t),i&&(i.textContent=n),r&&(r.textContent=s)}async function le(){const e=document.getElementById("todoInput"),t=localStorage.getItem("simpleTodo_pseudo");if(!e)return;const n=e.value.trim();if(!n){l("Veuillez entrer une tâche");return}try{(await fetch(`${u}/api/todos/${C}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:n,pseudo:t||"Anonyme"})})).ok?(e.value="",E()):l("Erreur lors de l'ajout de la tâche")}catch(s){console.error("Erreur lors de l'ajout de la tâche:",s),l("Erreur de connexion")}}async function Ne(e){const t=document.querySelector(`.todo-item[data-id="${e}"]`),s=!((t==null?void 0:t.getAttribute("data-completed"))==="1");try{const o=await fetch(`${u}/api/todos/${C}/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({completed:s})});if(o.ok)E();else if(o.status===422){const i=await o.json().catch(()=>null);console.error("Validation toggle todo:",i),l((i==null?void 0:i.message)||"Validation impossible pour cette tâche")}else l("Erreur lors du changement d'état de la tâche")}catch(o){console.error("Erreur toggle todo:",o),l("Erreur de connexion")}}async function Ue(e){if(await S("Êtes-vous sûr de vouloir supprimer cette tâche ?"))try{(await fetch(`${u}/api/todos/${C}/${e}`,{method:"DELETE"})).ok?E():l("Erreur lors de la suppression de la tâche")}catch(n){console.error("Erreur suppression todo:",n),l("Erreur de connexion")}}async function qe(){if(await S("Êtes-vous sûr de vouloir supprimer toutes les tâches terminées ?"))try{(await fetch(`${u}/api/todos/${C}`,{method:"DELETE"})).ok?E():l("Erreur lors de la suppression des tâches terminées")}catch(t){console.error("Erreur clear completed:",t),l("Erreur de connexion")}}async function Fe(e){const t=localStorage.getItem("simpleTodo_pseudo")||"",n=typeof window<"u"&&window.userEmail?window.userEmail:B();if(!n){l("Impossible d'assigner la tâche : votre adresse email est introuvable. Veuillez vous reconnecter.");return}let s=t;if(!s&&window.isAuthenticated&&(s=n.split("@")[0],localStorage.setItem("simpleTodo_pseudo",s)),!s){l("Veuillez enregistrer votre pseudo avant de vous assigner une tâche.");return}try{const o=await fetch(`${u}/api/todos/${C}/${e}/assign`,{method:"POST",headers:{"Content-Type":"application/json","X-User-Email":n,"X-User-Pseudo":s},body:JSON.stringify({pseudo:s})});if(o.ok)E();else if(o.status===422){const i=await o.json().catch(()=>null);console.error("Validation assign todo:",i),l(i&&i.message||"Impossible d'assigner la tâche (422)")}else l("Erreur lors de l'assignation de la tâche")}catch(o){console.error("Erreur assign todo:",o),l("Erreur de connexion")}}Object.assign(window,{loadSelectedList:Se,createNewList:Be,requestAuthEmail:Me,alertBs:l,confirmBs:S,addTodo:le,saveTitle:ot,cancelTitleEdit:et,editTitle:Ze,subscribe:z,unsubscribe:it,inviteCollaborator:he,addCategory:dt,savePseudo:ce,savePseudoFromModal:de,changeHeaderGradient:Re,saveAutoAssignOption:Ve,deleteCategory:ut,clearCompleted:qe,confirmDeleteList:tt,runServerUpdate:ze,shareListUrl:st,toggleTodo:Ne,toggleComments:We,assignTodo:Fe,changeCategory:Xe,changeDueDate:Ge,deleteTodo:Ue,addComment:fe,resendSubscriberLink:at,updateCommentBadge:me});Ie();Le();let d=F();J(d);let q=!1,N=!1;if(!d){const t=window.location.pathname.match(/^\/([^\/]+)$/);t&&t[1]&&t[1]!=="index.html"&&(d=t[1],ie(d),J(d))}d||re();function M(){const e=localStorage.getItem("simpleTodo_pseudo"),t=document.getElementById("pseudo");return e&&t?(t.value=e,e):null}function ce(){const e=document.getElementById("pseudo");if(!e)return;const t=e.value.trim();t?(localStorage.setItem("simpleTodo_pseudo",t),P(),new bootstrap.Collapse(document.getElementById("userSettings"),{toggle:!0})):l("Veuillez entrer un pseudo")}function P(){const e=M(),t=f(),n=document.querySelector(".user-pseudo"),s=n?n.querySelector(".user-pseudo-text"):null;n&&s&&e?(s.textContent=e,n.style.display="inline-flex"):n&&(s&&(s.textContent=""),n.style.display="none");const o=document.getElementById("userInfo");if(o&&(o.style.display=e||window.isAuthenticated&&B()?"flex":"none"),t){const i=document.getElementById("emailBadge");i&&(i.style.display="inline-block")}else{const i=document.getElementById("emailBadge");i&&(i.style.display="none")}}const O={gradient1:"linear-gradient(135deg, #8fa4f5 0%, #b491e8 100%)",gradient2:"linear-gradient(135deg, #f66 0%, #ff9240 100%)",gradient3:"linear-gradient(135deg, #56ab2f 0%, #a8e063 100%)",gradient4:"linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)",gradient5:"linear-gradient(135deg, #fd79a8 0%, #e84393 100%)",gradient6:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",gradient7:"linear-gradient(135deg, #fdcb6e 0%, #e17055 100%)",gradient8:"linear-gradient(135deg, #a29bfe 0%, #fd79a8 100%)"};async function Je(){let e="gradient1";try{const o=await(await fetch(`${u}/api/lists/${d}`)).json();o.header_gradient&&(e=o.header_gradient)}catch(s){console.error("Erreur chargement gradient:",s)}const t=document.querySelector(".card-header");t&&O[e]&&(t.style.background=O[e]);const n=document.getElementById("headerGradient");n&&(n.value=e)}async function Re(){const e=document.getElementById("headerGradient").value,t=document.querySelector(".card-header");if(t&&O[e]){t.style.background=O[e];try{await fetch(`${u}/api/lists/${d}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-Token":window.csrfToken},body:JSON.stringify({header_gradient:e})})}catch(n){console.error("Erreur sauvegarde gradient:",n)}}}async function Ve(){const e=document.getElementById("autoAssignToCreator");if(!e)return;const t=e.checked;window.autoAssignToCreator=t;try{const n=await fetch(`${u}/api/lists/${d}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-Token":window.csrfToken},body:JSON.stringify({auto_assign_to_creator:t})});n.ok||(console.error("Erreur sauvegarde option assignation:",n.statusText),e.checked=!t,window.autoAssignToCreator=!t)}catch(n){console.error("Erreur sauvegarde option assignation:",n),e.checked=!t,window.autoAssignToCreator=!t}}document.addEventListener("DOMContentLoaded",function(){je();const e=localStorage.getItem("simpleTodo_pseudo");let t=Ae();if(d=F(),J(d),t&&d){const i={listId:d,token:t};te().then(r=>{r&&(i.title=r),localStorage.setItem(`simpleTodo_token_${t}`,JSON.stringify(i))}).catch(r=>{localStorage.setItem(`simpleTodo_token_${t}`,JSON.stringify(i))})}const n=j.get("email");n&&(document.getElementById("email").value=n,localStorage.getItem("simpleTodo_pseudo")&&setTimeout(function(){z()},500)),e||(new bootstrap.Modal(document.getElementById("pseudoModal")).show(),setTimeout(function(){document.getElementById("modalPseudo").focus()},500)),typeof window<"u"&&window.isAuthenticated&&window.userEmail?A(window.userEmail):U(),M(),te(),Je(),P(),U(),X(),E(),G();const s=document.querySelector(".user-pseudo");s&&(s.style.cursor="pointer",s.addEventListener("click",function(){(window.userEmail||f()||"").trim()&&(window.location.href="/")})),setInterval(ct,5e3);const o=document.getElementById("userSettings");o&&o.addEventListener("show.bs.collapse",function(){W()})});async function ze(){const e=document.getElementById("updateOutput"),t=document.getElementById("updateStatus");e&&(e.textContent="Exécution en cours..."),t&&(t.style.display="block",t.textContent="");try{const n=!!(document.getElementById("updateForce")&&document.getElementById("updateForce").checked),s=await fetch(`${u}/api/update`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":window.csrfToken,"X-User-Email":window.userEmail||f()||""},body:JSON.stringify({email:window.userEmail||f()||"",force:n})}),o=await s.json(),i=[];i.push(`Success: ${!!o.success}`),typeof o.code<"u"&&i.push(`Exit code: ${o.code}`),o.stdout&&(i.push(`
--- stdout ---`),i.push(o.stdout)),o.stderr&&(i.push(`
--- stderr ---`),i.push(o.stderr)),e&&(e.textContent=i.join(`
`)),t&&(t.textContent=s.ok?"Mise à jour terminée.":"Erreur lors de la mise à jour.")}catch(n){e&&(e.textContent=`Erreur: ${n}`),t&&(t.textContent="Erreur lors de la mise à jour.")}}function de(){const e=document.getElementById("modalPseudo").value.trim();if(e){localStorage.setItem("simpleTodo_pseudo",e),P();const t=j.get("email");t&&(document.getElementById("email").value=t,setTimeout(function(){z()},300)),bootstrap.Modal.getInstance(document.getElementById("pseudoModal")).hide()}else l("Veuillez entrer un pseudo")}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("modalPseudo");e&&e.addEventListener("keypress",function(t){t.key==="Enter"&&de()})});function D(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async function Ge(e){const t=document.querySelector(`[data-id="${e}"]`);if(!t){l("Impossible de récupérer la tâche ciblée. Veuillez recharger la page.");return}const n=t.getAttribute("data-due-date")||"",s=n?new Date(n).toLocaleDateString("fr-FR",{day:"numeric",month:"numeric",year:"numeric"}):"Aucune date",o=document.createElement("div");o.innerHTML=`
        <div class="modal fade" id="dueDateModal" tabindex="-1" aria-labelledby="dueDateModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="dueDateModalLabel"><i class="bi bi-calendar-event"></i> Modifier la date d'échéance</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="newDueDate" class="form-label">Nouvelle date</label>
                            <input type="date" class="form-control" id="newDueDate" value="${n}" min="${new Date().toISOString().split("T")[0]}">
                        </div>
                        <p class="text-muted">Date actuelle : ${s}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" id="removeDueDateBtn">Supprimer la date</button>
                        <button type="button" class="btn btn-primary" id="saveDueDateBtn">Sauvegarder</button>
                    </div>
                </div>
            </div>
        </div>
    `,document.body.appendChild(o);const i=document.getElementById("dueDateModal"),r=new bootstrap.Modal(i);r.show();const a=document.getElementById("newDueDate"),c=document.getElementById("saveDueDateBtn"),m=document.getElementById("removeDueDateBtn"),g=()=>{r.hide(),setTimeout(()=>o.remove(),300)};c.addEventListener("click",async()=>{try{const p=a.value;(await fetch(`${u}/api/todos/${d}/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({due_date:p})})).ok?(g(),E()):l("Erreur lors de la modification de la date d'échéance")}catch(p){console.error("Erreur:",p),l("Erreur lors de la modification de la date d'échéance")}}),m.addEventListener("click",async()=>{try{(await fetch(`${u}/api/todos/${d}/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({due_date:null})})).ok?(g(),E()):l("Erreur lors de la suppression de la date d'échéance")}catch(p){console.error("Erreur:",p),l("Erreur lors de la suppression de la date d'échéance")}})}async function Xe(e){const n=document.querySelector(`[data-id="${e}"]`).dataset.category||"",s=`
        <div class="modal fade" id="categoryModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Changer la catégorie</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <label class="form-label">Catégorie</label>
                        <select id="categorySelect" class="form-select">
                            <option value="">Aucune catégorie</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="button" class="btn btn-primary" onclick="saveCategoryChange(${e})">Sauvegarder</button>
                    </div>
                </div>
            </div>
        </div>
    `,o=document.getElementById("categoryModal");o&&o.remove(),document.body.insertAdjacentHTML("beforeend",s);const i=document.getElementById("categorySelect");i.innerHTML='<option value="">Aucune catégorie</option>',H.forEach(a=>{const c=document.createElement("option");c.value=a.id,c.textContent=a.name,c.style.backgroundColor=a.color,c.style.color="white",a.id==n&&(c.selected=!0),i.appendChild(c)});const r=new bootstrap.Modal(document.getElementById("categoryModal"));r.show(),window.saveCategoryChange=async function(a){const c=i.value||null;try{(await fetch(`${u}/api/todos/${d}/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({category_id:c})})).ok?(r.hide(),setTimeout(()=>document.getElementById("categoryModal").remove(),300),E()):l("Erreur lors du changement de catégorie")}catch(m){console.error("Erreur:",m),l("Erreur lors du changement de catégorie")}}}const K=document.getElementById("todoInput");K&&K.addEventListener("keypress",function(e){e.key==="Enter"&&le()});const Y=document.getElementById("pseudo");Y&&Y.addEventListener("keypress",function(e){e.key==="Enter"&&ce()});const Z=document.getElementById("inviteEmail");Z&&Z.addEventListener("keypress",function(e){e.key==="Enter"&&he()});async function We(e){const t=document.getElementById(`comments-${e}`);t&&(t.style.display==="none"||t.style.display===""?(t.style.display="block",ue(e)):t.style.display="none")}async function ue(e){try{const[t,n]=await Promise.all([fetch(`${u}/api/comments/${d}/${e}`).then(o=>o.json()),ye(e)]),s=pe(t);Qe(e,t),R(e,t.length,n.new_comments,s),s&&await Ye(e,s)}catch(t){console.error("Erreur lors du chargement des commentaires:",t)}}async function me(e){try{const[t,n]=await Promise.all([fetch(`${u}/api/comments/${d}/${e}`).then(i=>i.json()),ye(e)]),s=document.getElementById(`comment-badge-${e}`),o=pe(t);if(!s)return;be(s,t.length),R(e,t.length,n.new_comments,o)}catch(t){console.error("Erreur lors du chargement du badge:",t)}}function Qe(e,t){const n=document.getElementById(`comments-list-${e}`);if(t.length===0){n.innerHTML='<div class="text-muted small">Aucun commentaire</div>',R(e,0,0,0),ee(e);return}n.innerHTML=t.map(s=>{const o=s.created_at?lt(s.created_at):"";return`
        <div class="comment-item">
            <div class="comment-pseudo">${D(s.pseudo)}</div>
            <div>${D(s.text)}</div>
            ${o?`<div class="text-muted small fst-italic mt-1">${o}</div>`:""}
        </div>
        `}).join(""),ee(e)}function pe(e){return!Array.isArray(e)||e.length===0?0:e.reduce((t,n)=>{const s=Number(n==null?void 0:n.id)||0;return s>t?s:t},0)}async function fe(e){const t=document.getElementById(`comment-input-${e}`);if(!t)return;const n=t.value.trim(),s=M();if(!n){l("Veuillez entrer un commentaire");return}if(!s){l("Veuillez d'abord entrer votre pseudo");return}try{(await fetch(`${u}/api/comments/${d}/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:n,pseudo:s})})).ok&&(t.value="",ue(e),me(e))}catch(o){console.error("Erreur:",o),l("Erreur lors de l'ajout du commentaire")}}function ee(e){const t=document.getElementById(`comment-input-${e}`);!t||t.dataset.enterHandler==="true"||(t.addEventListener("keydown",n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),fe(e))}),t.dataset.enterHandler="true")}async function ge(){const e=(window.adminEmail||"").toLowerCase(),t=(window.userEmail||f()||"").trim().toLowerCase();if(!(!e||!t||e!==t)&&!(q||N)){N=!0;try{const n=await fetch(`${u}/api/update/check`);if(!n.ok)return;const s=await n.json();if(!s.success||(q=!0,!s.has_update))return;const o=document.getElementById("updateLinkContainer"),i=document.getElementById("updateLink");if(!o||!i)return;const r=[];s.remote_tag&&r.push(s.remote_tag),s.remote_name&&r.push(s.remote_name);const a=r.join(" - ");i.textContent=a?`Mettre à jour l'application (${a})`:"Mettre à jour l'application",i.classList.remove("d-none"),o.classList.remove("d-none")}catch(n){console.error("Erreur lors de la vérification de mise à jour:",n)}finally{N=!1}}}function Ke(e,t){const n=document.getElementById(`comment-button-${e}`);n&&(n.classList.remove("btn-outline-secondary","btn-outline-primary"),t>0?n.classList.add("btn-outline-primary"):n.classList.add("btn-outline-secondary"))}function R(e,t,n,s){Ke(e,t);const o=document.getElementById(`comment-new-badge-${e}`);o&&(be(o,n),o.dataset.lastCommentId=String(s||""))}async function Ye(e,t){const n=f();if(!n||!d||!t)return 0;try{const s=await fetch(`${u}/api/subscribers/${d}/todos/${e}/last-comment`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:n,comment_id:t})});if(!s.ok)return 0;const o=await s.json();return Number((o==null?void 0:o.new_comments)||0)}catch(s){return console.error("Erreur lors de la mise à jour du dernier commentaire consulté:",s),0}}async function ye(e){const t=f();if(!t||!d)return{stored_comment_id:0,new_comments:0};try{const n=await fetch(`${u}/api/subscribers/${d}/todos/${e}/last-comment?email=${encodeURIComponent(t)}`);return n.ok?await n.json():{stored_comment_id:0,new_comments:0}}catch(n){return console.error("Erreur lors de la récupération du dernier commentaire consulté:",n),{stored_comment_id:0,new_comments:0}}}function be(e,t){e&&(e.textContent=t>0?t:"",e.classList.toggle("d-none",t===0))}async function te(){const e=j.get("title");let t="SimpleTodo";if(e){t=decodeURIComponent(e),document.getElementById("listTitle").textContent=t,localStorage.setItem(`simpleTodo_list_${d}`,JSON.stringify({listId:d,title:t}));const o=f();try{if(await fetch(`${u}/api/lists/${d}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t,creator_email:o})}),o){window.isListCreator=!0,console.log("isListCreator set to true (new list creation)"),A(o);try{const i=M()||"Créateur";await fetch(`${u}/api/subscribers/${d}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:o,pseudo:i})})}catch(i){console.error("Erreur abonnement auto:",i)}}}catch(i){console.error("Erreur sauvegarde liste:",i)}return ne(),ge(),t}const n=f(),s=n?`${u}/api/lists/${d}?email=${encodeURIComponent(n)}`:`${u}/api/lists/${d}`;try{const i=await(await fetch(s)).json();t=i.title||"SimpleTodo",window.isListCreator=i.is_creator,window.isSubscriber=i.is_subscriber||!1,window.autoAssignToCreator=i.auto_assign_to_creator||!1,window.adminEmail=(i.admin_email||"").toLowerCase(),console.log("isListCreator from API:",window.isListCreator),console.log("isSubscriber from API:",window.isSubscriber),console.log("autoAssignToCreator from API:",window.autoAssignToCreator),console.log("Creator email from API:",i.creator_email),window.isListCreator&&!f()&&i.creator_email&&(A(i.creator_email),console.log("Creator email set from API:",i.creator_email));const r=document.getElementById("autoAssignToCreator");r&&(r.checked=window.autoAssignToCreator),ne(),V();const a=document.getElementById("listTitle");a&&(a.textContent=t)}catch(o){console.error("Erreur lors du chargement du titre:",o);const i=document.getElementById("listTitle");i&&(i.textContent="SimpleTodo")}return t}function Ze(){const e=document.getElementById("titleInput"),t=document.getElementById("titleField");t.value=document.getElementById("listTitle").textContent,e.style.display="block"}function et(){document.getElementById("titleInput").style.display="none"}function ne(){console.log("updateDeleteButton called, isListCreator:",window.isListCreator);const e=document.getElementById("deleteListBtnSettings");e&&window.isListCreator?e.classList.remove("d-none"):e&&e.classList.add("d-none");const t=document.querySelectorAll(".creator-only");console.log("Found",t.length,"creator-only sections"),t.forEach(o=>{window.isListCreator?(o.classList.add("show"),o.classList.remove("d-none")):(o.classList.remove("show"),o.classList.add("d-none"))});const n=document.getElementById("updateLinkContainer"),s=document.getElementById("updateLink");window.isListCreator?(n&&n.classList.add("d-none"),s&&s.classList.add("d-none"),ge()):(n&&n.classList.add("d-none"),s&&s.classList.add("d-none"),q=!1)}async function tt(){await S(`Attention : Cette action est irréversible !

Voulez-vous vraiment supprimer cette liste et toutes ses tâches ?`)&&await nt()}async function nt(){const e=f();if(!e){l("Erreur : Email non trouvé");return}try{const t=`${u}/api/lists/${d}?email=${encodeURIComponent(e)}`,n=await fetch(t,{method:"DELETE"});if(n.ok)l("Liste supprimée avec succès"),re();else{const s=await n.json();l(s.error||"Erreur lors de la suppression de la liste")}}catch(t){console.error("Erreur:",t),l("Erreur lors de la suppression de la liste")}}async function ot(){const t=document.getElementById("titleField").value.trim();if(!t){l("Veuillez entrer un titre");return}try{const n=f(),s=n?`${u}/api/lists/${d}?email=${encodeURIComponent(n)}`:`${u}/api/lists/${d}`;(await fetch(s,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t})})).ok?(document.getElementById("listTitle").textContent=t,document.getElementById("titleInput").style.display="none"):l("Erreur lors de la sauvegarde du titre")}catch(n){console.error("Erreur:",n),l("Erreur lors de la sauvegarde du titre")}}function st(){if(!d){l("Aucune liste sélectionnée");return}const t=`${window.location.origin}/?list=${d}`;navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(t).then(()=>{l(`Lien copié dans le presse-papiers !

`+t)}).catch(n=>{console.error("Erreur lors de la copie:",n),oe(t)}):oe(t)}function oe(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy"),l(`Lien copié dans le presse-papiers !

`+e)}catch(n){console.error("Erreur lors de la copie:",n),prompt("Copiez ce lien manuellement:",e)}document.body.removeChild(t)}function V(){const e=f(),t=document.getElementById("emailSubscription"),n=document.getElementById("emailUnsubscribe"),s=document.getElementById("emailDisplay");if(!e){t&&(t.style.display="block"),n&&(n.style.display="none");return}window.isSubscriber?(s&&(s.textContent=e),n&&(n.style.display="block"),t&&(t.style.display="none")):(s&&(s.textContent=""),t&&(t.style.display="block"),n&&(n.style.display="none"))}async function z(){const e=document.getElementById("email"),t=e.value.trim();if(!t||!t.includes("@"))return;const n=M();try{(await fetch(`${u}/api/subscribers/${d}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,pseudo:n})})).ok&&(A(t),e.value="",window.isSubscriber=!0,V(),P(),G())}catch(s){console.error("Erreur:",s),l("Erreur lors de l'inscription")}}async function it(){const e=f();if(e)try{(await fetch(`${u}/api/subscribers/${d}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})})).ok&&(document.getElementById("email").value="",window.isSubscriber=!1,V(),P(),G())}catch(t){console.error("Erreur:",t),l("Erreur lors de la désinscription")}}async function G(){try{const t=await(await fetch(`${u}/api/subscribers/${d}`)).json();await rt(t)}catch(e){console.error("Erreur:",e);const t=document.getElementById("subscribersList");t&&(t.innerHTML='<div class="text-white small text-center py-2">Erreur de chargement</div>')}}async function rt(e){const t=document.getElementById("subscribersList");if(!t)return;if(e.length===0){t.innerHTML='<div class="text-white small text-center py-2"><i class="bi bi-inbox"></i> Aucun abonné pour le moment</div>';return}let n=null;console.log("displaySubscribers - isListCreator:",window.isListCreator);try{const s=f(),o=s?`${u}/api/lists/${d}?email=${encodeURIComponent(s)}`:`${u}/api/lists/${d}`,r=await(await fetch(o)).json();n=r.creator_email,console.log("Creator email from API:",n),r.is_creator!==void 0&&(window.isListCreator=r.is_creator,console.log("isListCreator from API:",window.isListCreator))}catch(s){console.error("Erreur récupération email créateur:",s)}t.innerHTML=e.map(s=>{const o=n&&n.trim()===s.email.trim();return console.log("Subscriber:",s.email,"Creator email:",n,"isCreator:",o),`
        <div class="d-flex align-items-center justify-content-between py-1">
            <div>
                <small class="text-white">
                    ${o?'<i class="bi bi-star-fill text-warning me-1" title="Créateur"></i>':""}
                    ${D(s.pseudo||s.email)} 
                    ${s.pseudo?`<span class="text-white">(${D(s.email)})</span>`:""}
                </small>
            </div>
            <button class="btn btn-sm btn-light" onclick="resendSubscriberLink(${s.id})" title="Renvoyer le lien">
                <i class="bi bi-send"></i>
            </button>
        </div>
        `}).join("")}async function at(e){try{(await fetch(`${u}/api/subscribers/${d}/${e}/resend`,{method:"POST",headers:{"Content-Type":"application/json"}})).ok}catch(t){console.error("Erreur:",t)}}async function he(){const e=document.getElementById("inviteEmail"),t=e.value.trim();if(!t||!t.includes("@"))return;const n=M();try{(await fetch(`${u}/api/invitations/${d}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,invited_by:n||"Quelqu'un"})})).ok&&(e.value="")}catch(s){console.error("Erreur:",s)}}function lt(e){const t=new Date(e),s=new Date-t;if(s<6e4)return"À l'instant";if(s<36e5){const o=Math.floor(s/6e4);return`Il y a ${o} minute${o>1?"s":""}`}if(s<864e5){const o=Math.floor(s/36e5);return`Il y a ${o} heure${o>1?"s":""}`}if(s<6048e5){const o=Math.floor(s/864e5);return`Il y a ${o} jour${o>1?"s":""}`}return t.toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}let H=[];async function X(){try{H=await(await fetch(`${u}/api/categories/${d}`)).json()}catch(e){console.error("Erreur lors du chargement des catégories:",e)}}async function ct(){try{const e=await fetch(`${u}/api/email-queue/process`,{method:"POST"});if(e.ok){const t=await e.json();t.processed>0&&console.log(`Emails traités: ${t.sent} envoyés, ${t.failed} échoués`)}}catch{}}async function W(){const e=document.getElementById("categoriesContainer");if(e.innerHTML="",H.length===0){e.innerHTML='<div class="text-muted text-white small">Aucune catégorie</div>';return}H.forEach(t=>{const n=document.createElement("div");n.className="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom border-white",n.innerHTML=`
            <div class="d-flex align-items-center">
                <span class="badge rounded-pill me-2" style="background-color: ${t.color}; color: white;">
                    ${D(t.name)}
                </span>
            </div>
            <button class="btn btn-sm btn-outline-light" onclick="deleteCategory(${t.id})">
                <i class="bi bi-trash"></i>
            </button>
        `,e.appendChild(n)})}async function dt(){const e=document.getElementById("newCategoryName").value.trim(),t=document.getElementById("newCategoryColor").value;if(!e){l("Veuillez entrer un nom de catégorie");return}try{(await fetch(`${u}/api/categories/${d}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,color:t})})).ok&&(document.getElementById("newCategoryName").value="",X(),W())}catch(n){console.error("Erreur:",n),l("Erreur lors de l'ajout de la catégorie")}}async function ut(e){if(await S("Supprimer cette catégorie ?"))try{(await fetch(`${u}/api/categories/${d}/${e}`,{method:"DELETE"})).ok&&(X(),W())}catch(n){console.error("Erreur:",n)}}
