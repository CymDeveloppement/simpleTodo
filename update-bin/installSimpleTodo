#!/usr/bin/env bash

set -euo pipefail

# Aller à la racine du projet (dossier parent de update-bin)
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "$PROJECT_ROOT"

echo "=== Installation SimpleTodo ==="
echo "Répertoire: $(pwd)"

PHP_BIN="${PHP_CLI:-}"
if [[ -n "$PHP_BIN" ]]; then
    if [[ ! -x "$PHP_BIN" ]]; then
        echo "PHP_CLI fourni mais inexécutable (${PHP_BIN}). Recherche dans le PATH..."
        PHP_BIN=""
    fi
fi

if [[ -z "$PHP_BIN" ]]; then
    if command -v php >/dev/null 2>&1; then
        PHP_BIN="$(command -v php)"
    fi
fi

if [[ -z "$PHP_BIN" ]]; then
    echo "Erreur : php est requis mais introuvable." >&2
    exit 1
fi

echo "Utilisation de PHP CLI : ${PHP_BIN}"

HOME_DIR="${HOME:-$PROJECT_ROOT}"
COMPOSER_HOME_DIR="${COMPOSER_HOME:-$PROJECT_ROOT/.composer}"
mkdir -p "$HOME_DIR" "$COMPOSER_HOME_DIR"

COMPOSER_BIN=(composer)
if ! command -v composer >/dev/null 2>&1; then
    echo "Composer introuvable. Téléchargement en cours..."

    rm -f composer.phar composer-setup.php

    EXPECTED_CHECKSUM="$("$PHP_BIN" -r 'copy("https://composer.github.io/installer.sig", "php://stdout");')"
    "$PHP_BIN" -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    ACTUAL_CHECKSUM="$("$PHP_BIN" -r "echo hash_file('sha384', 'composer-setup.php');")"

    if [ "$EXPECTED_CHECKSUM" != "$ACTUAL_CHECKSUM" ]; then
        >&2 echo 'ERROR: Invalid installer checksum'
        rm -f composer-setup.php
        exit 1
    fi

    HOME="$HOME_DIR" COMPOSER_HOME="$COMPOSER_HOME_DIR" "$PHP_BIN" composer-setup.php --quiet
    RESULT=$?
    rm -f composer-setup.php

    if [ $RESULT -ne 0 ]; then
        >&2 echo "Erreur lors de l'installation de Composer (code $RESULT)."
        exit $RESULT
    fi

    COMPOSER_BIN=("$PHP_BIN" composer.phar)
    echo "Composer installé localement (composer.phar)."
elif [ -f composer.phar ]; then
    COMPOSER_BIN=("$PHP_BIN" composer.phar)
fi

if command -v git >/dev/null 2>&1; then
    if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        echo "Initialisation du dépôt git..."
        git init

        if ! git remote get-url origin >/dev/null 2>&1; then
            git remote add origin "https://github.com/CymDeveloppement/simpleTodo.git"
        fi

        echo "Synchronisation avec origin/main..."
        if git fetch --all; then
            if git ls-remote --exit-code origin main >/dev/null 2>&1; then
                git reset --hard origin/main
                git pull origin main
            else
                echo "Branche 'main' introuvable sur origin. Synchronisation ignorée."
            fi
        else
            echo "Impossible de récupérer les références distantes."
        fi
    fi
else
    echo "git n'est pas disponible, l'initialisation du dépôt est ignorée."
fi

echo "1/2 Installation des dépendances backend (composer)..."
HOME="$HOME_DIR" COMPOSER_HOME="$COMPOSER_HOME_DIR" "${COMPOSER_BIN[@]}" install --no-interaction --prefer-dist

if [[ ! -f .env && -f env.example ]]; then
    echo "Copie de env.example vers .env..."
    cp env.example .env
fi

echo "Préparation des répertoires de cache..."
mkdir -p storage/framework/cache storage/framework/sessions storage/framework/views

echo "2/2 Migration de la base..."
"$PHP_BIN" artisan migrate --force

if grep -q '^APP_KEY=$' .env 2>/dev/null; then
    echo "Génération de la clé applicative..."
    "$PHP_BIN" artisan key:generate --force
fi

echo "✅ Installation terminée."

