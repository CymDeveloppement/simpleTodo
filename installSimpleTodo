#!/usr/bin/env bash

set -euo pipefail

# Aller à la racine du projet (emplacement du script)
cd "$(dirname "$0")"

echo "=== Installation SimpleTodo ==="
echo "Répertoire: $(pwd)"

if ! command -v composer >/dev/null 2>&1; then
    echo "Erreur : composer est requis mais introuvable." >&2
    exit 1
fi

if ! command -v npm >/dev/null 2>&1; then
    echo "Erreur : npm est requis mais introuvable." >&2
    exit 1
fi

if ! command -v php >/dev/null 2>&1; then
    echo "Erreur : php est requis mais introuvable." >&2
    exit 1
fi

echo "1/3 Composer install..."
composer install --no-interaction --prefer-dist

if [[ ! -f .env && -f env.example ]]; then
    echo "Copie de env.example vers .env..."
    cp env.example .env
fi

echo "Préparation des répertoires de cache..."
mkdir -p storage/framework/cache storage/framework/sessions storage/framework/views

echo "2/3 Build des assets..."
npm install
npm run build

echo "3/3 Migration de la base..."
php artisan migrate --force

if grep -q '^APP_KEY=$' .env 2>/dev/null; then
    echo "Génération de la clé applicative..."
    php artisan key:generate --force
fi

echo "✅ Installation terminée."

