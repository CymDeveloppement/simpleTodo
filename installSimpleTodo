#!/usr/bin/env bash

set -euo pipefail

# Aller à la racine du projet (emplacement du script)
cd "$(dirname "$0")"

echo "=== Installation SimpleTodo ==="
echo "Répertoire: $(pwd)"

if ! command -v php >/dev/null 2>&1; then
    echo "Erreur : php est requis mais introuvable." >&2
    exit 1
fi

COMPOSER_BIN="composer"
if ! command -v composer >/dev/null 2>&1; then
    echo "Composer introuvable. Téléchargement en cours..."

    rm -f composer.phar composer-setup.php

    EXPECTED_CHECKSUM="$(php -r 'copy("https://composer.github.io/installer.sig", "php://stdout");')"
    php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    ACTUAL_CHECKSUM="$(php -r "echo hash_file('sha384', 'composer-setup.php');")"

    if [ "$EXPECTED_CHECKSUM" != "$ACTUAL_CHECKSUM" ]; then
        >&2 echo 'ERROR: Invalid installer checksum'
        rm -f composer-setup.php
        exit 1
    fi

    php composer-setup.php --quiet
    RESULT=$?
    rm -f composer-setup.php

    if [ $RESULT -ne 0 ]; then
        >&2 echo "Erreur lors de l'installation de Composer (code $RESULT)."
        exit $RESULT
    fi

    COMPOSER_BIN="php composer.phar"
    echo "Composer installé localement (composer.phar)."
elif [ -f composer.phar ]; then
    COMPOSER_BIN="php composer.phar"
fi

if command -v git >/dev/null 2>&1; then
    if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        echo "Initialisation du dépôt git..."
        git init

        if ! git remote get-url origin >/dev/null 2>&1; then
            git remote add origin "https://github.com/CymDeveloppement/simpleTodo.git"
        fi

        echo "Synchronisation avec origin/main..."
        if git fetch --all; then
            if git ls-remote --exit-code origin main >/dev/null 2>&1; then
                git reset --hard origin/main
                git pull origin main
            else
                echo "Branche 'main' introuvable sur origin. Synchronisation ignorée."
            fi
        else
            echo "Impossible de récupérer les références distantes."
        fi
    fi
else
    echo "git n'est pas disponible, l'initialisation du dépôt est ignorée."
fi

echo "1/2 Installation des dépendances backend (composer)..."
$COMPOSER_BIN install --no-interaction --prefer-dist

if [[ ! -f .env && -f env.example ]]; then
    echo "Copie de env.example vers .env..."
    cp env.example .env
fi

echo "Préparation des répertoires de cache..."
mkdir -p storage/framework/cache storage/framework/sessions storage/framework/views

echo "2/2 Migration de la base..."
php artisan migrate --force

if grep -q '^APP_KEY=$' .env 2>/dev/null; then
    echo "Génération de la clé applicative..."
    php artisan key:generate --force
fi

echo "✅ Installation terminée."

